<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory RBT_set_opt</title>
</head>


<body>
<div class="head">
<h1>Theory RBT_set_opt</h1>
</div>

<pre class="source"><span class="keyword1"><span class="command">theory</span></span> RBT_set_opt
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Library/RBT_Impl.html">HOL-Library.RBT_Impl</a>"</span> <span class="quoted">"<a href="../Containers/Set_Impl.html">Containers.Set_Impl</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> urbt <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> unit<span class="main">)</span> RBT_Impl.rbt"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_empty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> urbt <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_empty</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span> RBT_Impl.Empty <span class="main">⇒</span> True <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_empty_prop<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_empty <span class="free">t</span> <span class="main">⟷</span> <span class="free">t</span> <span class="main">=</span> RBT_Impl.Empty"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_empty_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> RBT_Impl.rbt.splits<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">small_rbt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> urbt <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">small_rbt</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟷</span> bheight <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">&lt;</span> <span class="numeral">6</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">flip_rbt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> urbt <span class="main">⇒</span> <span class="tfree">'a</span> urbt <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">flip_rbt</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">⟷</span> bheight <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">&lt;</span> bheight <span class="free"><span class="bound"><span class="entity">t1</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">MR</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">MR</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> Branch RBT_Impl.R <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">()</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">MB</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">MB</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> Branch RBT_Impl.B <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">()</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">baliL</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> urbt <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> urbt <span class="main">⇒</span> <span class="tfree">'a</span> urbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">baliL</span> <span class="main">(</span>MR <span class="main">(</span>MR <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t4</span></span></span> <span class="main">=</span> MR <span class="main">(</span>MB <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>MB <span class="free"><span class="bound"><span class="entity">t3</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t4</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">baliL</span> <span class="main">(</span>MR <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>MR <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t4</span></span></span> <span class="main">=</span> MR <span class="main">(</span>MB <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>MB <span class="free"><span class="bound"><span class="entity">t3</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t4</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">baliL</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> MB <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">baliR</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> urbt <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> urbt <span class="main">⇒</span> <span class="tfree">'a</span> urbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">baliR</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>MR <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>MR <span class="free"><span class="bound"><span class="entity">t3</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t4</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> MR <span class="main">(</span>MB <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>MB <span class="free"><span class="bound"><span class="entity">t3</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t4</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">baliR</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>MR <span class="main">(</span>MR <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t4</span></span></span><span class="main">)</span> <span class="main">=</span> MR <span class="main">(</span>MB <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>MB <span class="free"><span class="bound"><span class="entity">t3</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t4</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">baliR</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> MB <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">paint</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"color <span class="main">⇒</span> <span class="tfree">'a</span> urbt <span class="main">⇒</span> <span class="tfree">'a</span> urbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">paint</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> RBT_Impl.Empty <span class="main">=</span> RBT_Impl.Empty"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">paint</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>RBT_Impl.Branch <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">()</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> RBT_Impl.Branch <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">()</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">baldL</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> urbt <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> urbt <span class="main">⇒</span> <span class="tfree">'a</span> urbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">baldL</span> <span class="main">(</span>MR <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span> <span class="main">=</span> MR <span class="main">(</span>MB <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">baldL</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>MB <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span><span class="main">)</span> <span class="main">=</span> baliR <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>MR <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">baldL</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>MR <span class="main">(</span>MB <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t4</span></span></span><span class="main">)</span> <span class="main">=</span> MR <span class="main">(</span>MB <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>baliR <span class="free"><span class="bound"><span class="entity">t3</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>paint RBT_Impl.R <span class="free"><span class="bound"><span class="entity">t4</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">baldL</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> MR <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">baldR</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> urbt <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> urbt <span class="main">⇒</span> <span class="tfree">'a</span> urbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">baldR</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>MR <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span><span class="main">)</span> <span class="main">=</span> MR <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>MB <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">baldR</span> <span class="main">(</span>MB <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span> <span class="main">=</span> baliL <span class="main">(</span>MR <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">baldR</span> <span class="main">(</span>MR <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>MB <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t4</span></span></span> <span class="main">=</span> MR <span class="main">(</span>baliL <span class="main">(</span>paint RBT_Impl.R <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>MB <span class="free"><span class="bound"><span class="entity">t3</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t4</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">baldR</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> MR <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">app</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> urbt <span class="main">⇒</span> <span class="tfree">'a</span> urbt <span class="main">⇒</span> <span class="tfree">'a</span> urbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">app</span> RBT_Impl.Empty <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">app</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> RBT_Impl.Empty <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">app</span> <span class="main">(</span>MR <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">(</span>MR <span class="free"><span class="bound"><span class="entity">t3</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t4</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">app</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span> <span class="keyword1">of</span>
    MR <span class="bound">u2</span> <span class="bound">b</span> <span class="bound">u3</span> <span class="main">⇒</span> <span class="main">(</span>MR <span class="main">(</span>MR <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">u2</span><span class="main">)</span> <span class="bound">b</span> <span class="main">(</span>MR <span class="bound">u3</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t4</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> <span class="bound">t23</span> <span class="main">⇒</span> MR <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>MR <span class="bound">t23</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t4</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">app</span> <span class="main">(</span>MB <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">(</span>MB <span class="free"><span class="bound"><span class="entity">t3</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t4</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">app</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span> <span class="keyword1">of</span>
    MR <span class="bound">u2</span> <span class="bound">b</span> <span class="bound">u3</span> <span class="main">⇒</span> MR <span class="main">(</span>MB <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">u2</span><span class="main">)</span> <span class="bound">b</span> <span class="main">(</span>MB <span class="bound">u3</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t4</span></span></span><span class="main">)</span>
  <span class="main">|</span> <span class="bound">t23</span> <span class="main">⇒</span> baldL <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>MB <span class="bound">t23</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t4</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">app</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">(</span>MR <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span><span class="main">)</span> <span class="main">=</span> MR <span class="main">(</span><span class="free">app</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">app</span> <span class="main">(</span>MR <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span> <span class="main">=</span> MR <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free">app</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rbt_joinL</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> urbt <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> urbt <span class="main">⇒</span> <span class="tfree">'a</span> urbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rbt_joinL</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> bheight <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≥</span> bheight <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">then</span> MR <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
    <span class="keyword1">else</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">of</span> MB <span class="bound">l'</span> <span class="bound">x'</span> <span class="bound">r'</span> <span class="main">⇒</span> baliL <span class="main">(</span><span class="free">rbt_joinL</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">l'</span><span class="main">)</span> <span class="bound">x'</span> <span class="bound">r'</span>
    <span class="main">|</span> MR <span class="bound">l'</span> <span class="bound">x'</span> <span class="bound">r'</span> <span class="main">⇒</span> MR <span class="main">(</span><span class="free">rbt_joinL</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">l'</span><span class="main">)</span> <span class="bound">x'</span> <span class="bound">r'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rbt_joinR</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> urbt <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> urbt <span class="main">⇒</span> <span class="tfree">'a</span> urbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rbt_joinR</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> bheight <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≤</span> bheight <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">then</span> MR <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
    <span class="keyword1">else</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">of</span> MB <span class="bound">l'</span> <span class="bound">x'</span> <span class="bound">r'</span> <span class="main">⇒</span> baliR <span class="bound">l'</span> <span class="bound">x'</span> <span class="main">(</span><span class="free">rbt_joinR</span> <span class="bound">r'</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>
    <span class="main">|</span> MR <span class="bound">l'</span> <span class="bound">x'</span> <span class="bound">r'</span> <span class="main">⇒</span> MR <span class="bound">l'</span> <span class="bound">x'</span> <span class="main">(</span><span class="free">rbt_joinR</span> <span class="bound">r'</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rbt_join</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> urbt <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> urbt <span class="main">⇒</span> <span class="tfree">'a</span> urbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rbt_join</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> bheight <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">&gt;</span> bheight <span class="free"><span class="bound"><span class="entity">r</span></span></span>
    <span class="keyword1">then</span> paint RBT_Impl.B <span class="main">(</span>rbt_joinR <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> bheight <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">&lt;</span> bheight <span class="free"><span class="bound"><span class="entity">r</span></span></span>
    <span class="keyword1">then</span> paint RBT_Impl.B <span class="main">(</span>rbt_joinL <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> MB <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> rbt_joinL.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> rbt_joinR.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>paint <span class="free">c</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> size <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> size_baliL<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>baliL <span class="free">t1</span> <span class="free">x</span> <span class="free">t2</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>size <span class="free">t1</span> <span class="main">+</span> size <span class="free">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baliL.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> size_baliR<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>baliR <span class="free">t1</span> <span class="free">x</span> <span class="free">t2</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>size <span class="free">t1</span> <span class="main">+</span> size <span class="free">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baliR.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> size_baldL<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>baldL <span class="free">t1</span> <span class="free">x</span> <span class="free">t2</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>size <span class="free">t1</span> <span class="main">+</span> size <span class="free">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baldL.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> size_baldR<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>baldR <span class="free">t1</span> <span class="free">x</span> <span class="free">t2</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>size <span class="free">t1</span> <span class="main">+</span> size <span class="free">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baldR.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> size_app<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>app <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span> <span class="main">=</span> size <span class="free">t1</span> <span class="main">+</span> size <span class="free">t2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">t2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> app.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> RBT_Impl.rbt.splits RBT_Impl.color.splits unit.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> size_rbt_joinL<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>rbt_joinL <span class="free">t1</span> <span class="free">x</span> <span class="free">t2</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>size <span class="free">t1</span> <span class="main">+</span> size <span class="free">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rbt_joinL.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rbt_joinL.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> RBT_Impl.rbt.splits RBT_Impl.color.splits unit.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> size_rbt_joinR<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>rbt_joinR <span class="free">t1</span> <span class="free">x</span> <span class="free">t2</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>size <span class="free">t1</span> <span class="main">+</span> size <span class="free">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rbt_joinR.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rbt_joinR.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> RBT_Impl.rbt.splits RBT_Impl.color.splits unit.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> size_rbt_join<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"size <span class="main">(</span>rbt_join <span class="free">t1</span> <span class="free">x</span> <span class="free">t2</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>size <span class="free">t1</span> <span class="main">+</span> size <span class="free">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rbt_join_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">rbt</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟷</span> inv1 <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> inv2 <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rbt_Node<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> rbt <span class="main">(</span>RBT_Impl.Branch <span class="free">c</span> <span class="free">l</span> <span class="free">a</span> <span class="main">()</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> rbt <span class="free">l</span> <span class="main">∧</span> rbt <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rbt_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> color_of_paint_B<span class="main">:</span> <span class="quoted"><span class="quoted">"color_of <span class="main">(</span>paint RBT_Impl.B <span class="free">t</span><span class="main">)</span> <span class="main">=</span> RBT_Impl.B"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> paint2<span class="main">:</span> <span class="quoted"><span class="quoted">"paint <span class="free">c2</span> <span class="main">(</span>paint <span class="free">c1</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> paint <span class="free">c2</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> inv1_paint_B<span class="main">:</span> <span class="quoted"><span class="quoted">"inv1l <span class="free">t</span> <span class="main">⟹</span> inv1 <span class="main">(</span>paint RBT_Impl.B <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> inv2_paint<span class="main">:</span> <span class="quoted"><span class="quoted">"inv2 <span class="free">t</span> <span class="main">⟹</span> inv2 <span class="main">(</span>paint <span class="free">c</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> inv1_baliL<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>inv1l <span class="free">l</span><span class="main">;</span> inv1 <span class="free">r</span><span class="main">⟧</span> <span class="main">⟹</span> inv1 <span class="main">(</span>baliL <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baliL.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> inv1_baliR<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>inv1 <span class="free">l</span><span class="main">;</span> inv1l <span class="free">r</span><span class="main">⟧</span> <span class="main">⟹</span> inv1 <span class="main">(</span>baliR <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baliR.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> bheight_baliL<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bheight <span class="free">l</span> <span class="main">=</span> bheight <span class="free">r</span> <span class="main">⟹</span> bheight <span class="main">(</span>baliL <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>bheight <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baliL.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> bheight_baliR<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bheight <span class="free">l</span> <span class="main">=</span> bheight <span class="free">r</span> <span class="main">⟹</span> bheight <span class="main">(</span>baliR <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>bheight <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baliR.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> inv2_baliL<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> inv2 <span class="free">l</span><span class="main">;</span> inv2 <span class="free">r</span><span class="main">;</span> bheight <span class="free">l</span> <span class="main">=</span> bheight <span class="free">r</span> <span class="main">⟧</span> <span class="main">⟹</span> inv2 <span class="main">(</span>baliL <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baliL.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> inv2_baliR<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> inv2 <span class="free">l</span><span class="main">;</span> inv2 <span class="free">r</span><span class="main">;</span> bheight <span class="free">l</span> <span class="main">=</span> bheight <span class="free">r</span> <span class="main">⟧</span> <span class="main">⟹</span> inv2 <span class="main">(</span>baliR <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baliR.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> inv_baliR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> inv2 <span class="free">l</span><span class="main">;</span> inv2 <span class="free">r</span><span class="main">;</span> inv1 <span class="free">l</span><span class="main">;</span> inv1l <span class="free">r</span><span class="main">;</span> bheight <span class="free">l</span> <span class="main">=</span> bheight <span class="free">r</span> <span class="main">⟧</span>
 <span class="main">⟹</span> inv1 <span class="main">(</span>baliR <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> inv2 <span class="main">(</span>baliR <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> bheight <span class="main">(</span>baliR <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>bheight <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baliR.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> inv_baliL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> inv2 <span class="free">l</span><span class="main">;</span> inv2 <span class="free">r</span><span class="main">;</span> inv1l <span class="free">l</span><span class="main">;</span> inv1 <span class="free">r</span><span class="main">;</span> bheight <span class="free">l</span> <span class="main">=</span> bheight <span class="free">r</span> <span class="main">⟧</span>
 <span class="main">⟹</span> inv1 <span class="main">(</span>baliL <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> inv2 <span class="main">(</span>baliL <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> bheight <span class="main">(</span>baliL <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>bheight <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baliL.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> bheight_paint_R<span class="main">:</span>
  <span class="quoted"><span class="quoted">"color_of <span class="free">t</span> <span class="main">=</span> RBT_Impl.B <span class="main">⟹</span> bheight <span class="main">(</span>paint RBT_Impl.R <span class="free">t</span><span class="main">)</span> <span class="main">=</span> bheight <span class="free">t</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> inv2_baldL_inv1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> inv2 <span class="free">l</span><span class="main">;</span>  inv2 <span class="free">r</span><span class="main">;</span>  bheight <span class="free">l</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> bheight <span class="free">r</span><span class="main">;</span>  inv1 <span class="free">r</span> <span class="main">⟧</span>
   <span class="main">⟹</span> inv2 <span class="main">(</span>baldL <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> bheight <span class="main">(</span>baldL <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> bheight <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baldL.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv2_baliR inv2_paint bheight_baliR bheight_paint_R<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inv2_baldL_B<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> inv2 <span class="free">l</span><span class="main">;</span>  inv2 <span class="free">r</span><span class="main">;</span>  bheight <span class="free">l</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> bheight <span class="free">r</span><span class="main">;</span> color_of <span class="free">r</span> <span class="main">=</span> RBT_Impl.B <span class="main">⟧</span>
   <span class="main">⟹</span> inv2 <span class="main">(</span>baldL <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> bheight <span class="main">(</span>baldL <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> bheight <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baldL.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv2_baliR bheight_baliR<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inv1_baldL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>inv1l <span class="free">l</span><span class="main">;</span> inv1 <span class="free">r</span><span class="main">;</span> color_of <span class="free">r</span> <span class="main">=</span> RBT_Impl.B<span class="main">⟧</span> <span class="main">⟹</span> inv1 <span class="main">(</span>baldL <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baldL.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv1_baliR<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inv1lI<span class="main">:</span> <span class="quoted"><span class="quoted">"inv1 <span class="free">t</span> <span class="main">⟹</span> inv1l <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> neq_Black<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span> <span class="main">≠</span> RBT_Impl.B<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">c</span> <span class="main">=</span> RBT_Impl.R<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">c</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inv1 <span class="free">t</span> <span class="main">⟹</span> inv1l <span class="main">(</span>paint <span class="free">c</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> inv1l_baldL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> inv1l <span class="free">l</span><span class="main">;</span> inv1 <span class="free">r</span> <span class="main">⟧</span> <span class="main">⟹</span> inv1l <span class="main">(</span>baldL <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baldL.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv1_baliR paint2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inv2_baldR_inv1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> inv2 <span class="free">l</span><span class="main">;</span>  inv2 <span class="free">r</span><span class="main">;</span>  bheight <span class="free">l</span> <span class="main">=</span> bheight <span class="free">r</span> <span class="main">+</span> <span class="main">1</span><span class="main">;</span>  inv1 <span class="free">l</span> <span class="main">⟧</span>
  <span class="main">⟹</span> inv2 <span class="main">(</span>baldR <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> bheight <span class="main">(</span>baldR <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> bheight <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baldR.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv2_baliL bheight_baliL inv2_paint bheight_paint_R<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inv1_baldR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>inv1 <span class="free">l</span><span class="main">;</span> inv1l <span class="free">r</span><span class="main">;</span> color_of <span class="free">l</span> <span class="main">=</span> RBT_Impl.B<span class="main">⟧</span> <span class="main">⟹</span> inv1 <span class="main">(</span>baldR <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baldR.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv1_baliL<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inv1l_baldR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> inv1 <span class="free">l</span><span class="main">;</span> inv1l <span class="free">r</span> <span class="main">⟧</span> <span class="main">⟹</span>inv1l <span class="main">(</span>baldR <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baldR.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv1_baliL paint2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inv2_app<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> inv2 <span class="free">l</span><span class="main">;</span> inv2 <span class="free">r</span><span class="main">;</span> bheight <span class="free">l</span> <span class="main">=</span> bheight <span class="free">r</span> <span class="main">⟧</span>
  <span class="main">⟹</span> inv2 <span class="main">(</span>app <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> bheight <span class="main">(</span>app <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> bheight <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> app.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv2_baldL_B <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> RBT_Impl.rbt.splits RBT_Impl.color.splits unit.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inv1_app<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> inv1 <span class="free">l</span><span class="main">;</span> inv1 <span class="free">r</span> <span class="main">⟧</span> <span class="main">⟹</span>
    <span class="main">(</span>color_of <span class="free">l</span> <span class="main">=</span> RBT_Impl.B <span class="main">∧</span> color_of <span class="free">r</span> <span class="main">=</span> RBT_Impl.B <span class="main">⟶</span> inv1 <span class="main">(</span>app <span class="free">l</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> inv1l <span class="main">(</span>app <span class="free">l</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> app.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv1_baldL <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> RBT_Impl.rbt.splits RBT_Impl.color.splits unit.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inv_baldL<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> inv2 <span class="free">l</span><span class="main">;</span>  inv2 <span class="free">r</span><span class="main">;</span>  bheight <span class="free">l</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> bheight <span class="free">r</span><span class="main">;</span> inv1l <span class="free">l</span><span class="main">;</span> inv1 <span class="free">r</span> <span class="main">⟧</span>
   <span class="main">⟹</span> inv2 <span class="main">(</span>baldL <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> bheight <span class="main">(</span>baldL <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> bheight <span class="free">r</span>
  <span class="main">∧</span> inv1l <span class="main">(</span>baldL <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>color_of <span class="free">r</span> <span class="main">=</span> RBT_Impl.B <span class="main">⟶</span> inv1 <span class="main">(</span>baldL <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baldL.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv_baliR inv2_paint bheight_baliR bheight_paint_R paint2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inv_baldR<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> inv2 <span class="free">l</span><span class="main">;</span>  inv2 <span class="free">r</span><span class="main">;</span>  bheight <span class="free">l</span> <span class="main">=</span> bheight <span class="free">r</span> <span class="main">+</span> <span class="main">1</span><span class="main">;</span> inv1 <span class="free">l</span><span class="main">;</span> inv1l <span class="free">r</span> <span class="main">⟧</span>
   <span class="main">⟹</span> inv2 <span class="main">(</span>baldR <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> bheight <span class="main">(</span>baldR <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> bheight <span class="free">l</span>
  <span class="main">∧</span> inv1l <span class="main">(</span>baldR <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>color_of <span class="free">l</span> <span class="main">=</span> RBT_Impl.B <span class="main">⟶</span> inv1 <span class="main">(</span>baldR <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baldR.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv_baliL inv2_paint bheight_baliL bheight_paint_R paint2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inv_app<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> inv2 <span class="free">l</span><span class="main">;</span> inv2 <span class="free">r</span><span class="main">;</span> bheight <span class="free">l</span> <span class="main">=</span> bheight <span class="free">r</span><span class="main">;</span> inv1 <span class="free">l</span><span class="main">;</span> inv1 <span class="free">r</span> <span class="main">⟧</span>
  <span class="main">⟹</span> inv2 <span class="main">(</span>app <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> bheight <span class="main">(</span>app <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> bheight <span class="free">l</span>
  <span class="main">∧</span> inv1l <span class="main">(</span>app <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>color_of <span class="free">l</span> <span class="main">=</span> RBT_Impl.B <span class="main">∧</span> color_of <span class="free">r</span> <span class="main">=</span> RBT_Impl.B <span class="main">⟶</span> inv1 <span class="main">(</span>app <span class="free">l</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> app.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv2_baldL_B inv_baldL
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> RBT_Impl.rbt.splits RBT_Impl.color.splits unit.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> neq_LeafD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> RBT_Impl.Empty <span class="main">⟹</span> <span class="main">∃</span><span class="bound">l</span> <span class="bound">x</span> <span class="bound">c</span> <span class="bound">r</span><span class="main">.</span> <span class="free">t</span> <span class="main">=</span> RBT_Impl.Branch <span class="bound">c</span> <span class="bound">l</span> <span class="bound">x</span> <span class="main">()</span> <span class="bound">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> inv1l_rbt_joinL<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span> inv1 <span class="free">l</span><span class="main">;</span> inv1 <span class="free">r</span><span class="main">;</span> bheight <span class="free">l</span> <span class="main">≤</span> bheight <span class="free">r</span> <span class="main">⟧</span> <span class="main">⟹</span>
  inv1l <span class="main">(</span>rbt_joinL <span class="free">l</span> <span class="free">x</span> <span class="free">r</span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span>bheight <span class="free">l</span> <span class="main">≠</span> bheight <span class="free">r</span> <span class="main">∧</span> color_of <span class="free">r</span> <span class="main">=</span> RBT_Impl.B <span class="main">⟶</span> inv1<span class="main">(</span>rbt_joinL <span class="free">l</span> <span class="free">x</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rbt_joinL.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">l</span> <span class="skolem">x</span> <span class="skolem">r</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv1_baliL rbt_joinL.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> RBT_Impl.rbt.splits RBT_Impl.color.splits unit.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inv1l_rbt_joinR<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> inv1 <span class="free">l</span><span class="main">;</span> inv2 <span class="free">l</span><span class="main">;</span> inv1 <span class="free">r</span><span class="main">;</span> inv2 <span class="free">r</span><span class="main">;</span> bheight <span class="free">l</span> <span class="main">≥</span> bheight <span class="free">r</span> <span class="main">⟧</span> <span class="main">⟹</span>
  inv1l <span class="main">(</span>rbt_joinR <span class="free">l</span> <span class="free">x</span> <span class="free">r</span><span class="main">)</span>
  <span class="main">∧</span> <span class="main">(</span>bheight <span class="free">l</span> <span class="main">≠</span> bheight <span class="free">r</span> <span class="main">∧</span> color_of <span class="free">l</span> <span class="main">=</span> RBT_Impl.B <span class="main">⟶</span> inv1<span class="main">(</span>rbt_joinR <span class="free">l</span> <span class="free">x</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rbt_joinR.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">l</span> <span class="skolem">x</span> <span class="skolem">r</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv1_baliR rbt_joinR.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> RBT_Impl.rbt.splits RBT_Impl.color.splits unit.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bheight_rbt_joinL<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> inv2 <span class="free">l</span><span class="main">;</span> inv2 <span class="free">r</span><span class="main">;</span> bheight <span class="free">l</span> <span class="main">≤</span> bheight <span class="free">r</span> <span class="main">⟧</span> <span class="main">⟹</span> bheight <span class="main">(</span>rbt_joinL <span class="free">l</span> <span class="free">x</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> bheight <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rbt_joinL.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">l</span> <span class="skolem">x</span> <span class="skolem">r</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bheight_baliL rbt_joinL.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> RBT_Impl.rbt.splits RBT_Impl.color.splits unit.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inv2_rbt_joinL<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> inv2 <span class="free">l</span><span class="main">;</span>  inv2 <span class="free">r</span><span class="main">;</span>  bheight <span class="free">l</span> <span class="main">≤</span> bheight <span class="free">r</span> <span class="main">⟧</span> <span class="main">⟹</span> inv2 <span class="main">(</span>rbt_joinL <span class="free">l</span> <span class="free">x</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rbt_joinL.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">l</span> <span class="skolem">x</span> <span class="skolem">r</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv2_baliL bheight_rbt_joinL rbt_joinL.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> RBT_Impl.rbt.splits RBT_Impl.color.splits unit.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bheight_rbt_joinR<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> inv2 <span class="free">l</span><span class="main">;</span>  inv2 <span class="free">r</span><span class="main">;</span>  bheight <span class="free">l</span> <span class="main">≥</span> bheight <span class="free">r</span> <span class="main">⟧</span> <span class="main">⟹</span> bheight <span class="main">(</span>rbt_joinR <span class="free">l</span> <span class="free">x</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> bheight <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rbt_joinR.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">l</span> <span class="skolem">x</span> <span class="skolem">r</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bheight_baliR rbt_joinR.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> RBT_Impl.rbt.splits RBT_Impl.color.splits unit.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inv2_rbt_joinR<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> inv2 <span class="free">l</span><span class="main">;</span> inv2 <span class="free">r</span><span class="main">;</span> bheight <span class="free">l</span> <span class="main">≥</span> bheight <span class="free">r</span> <span class="main">⟧</span> <span class="main">⟹</span> inv2 <span class="main">(</span>rbt_joinR <span class="free">l</span> <span class="free">x</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rbt_joinR.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">l</span> <span class="skolem">x</span> <span class="skolem">r</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv2_baliR bheight_rbt_joinR rbt_joinR.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> RBT_Impl.rbt.splits RBT_Impl.color.splits unit.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bheight_paint_Black<span class="main">:</span> <span class="quoted"><span class="quoted">"bheight <span class="main">(</span>paint RBT_Impl.B <span class="free">t</span><span class="main">)</span> <span class="main">≤</span> bheight <span class="free">t</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> keys_paint<span class="main">:</span> <span class="quoted"><span class="quoted">"RBT_Impl.keys <span class="main">(</span>paint <span class="free">c</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> RBT_Impl.keys <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> keys_baliL<span class="main">:</span>
  <span class="quoted"><span class="quoted">"RBT_Impl.keys <span class="main">(</span>baliL <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> RBT_Impl.keys <span class="free">l</span> <span class="main">@</span> <span class="free">a</span> <span class="main">#</span> RBT_Impl.keys <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">a</span><span class="main">,</span><span class="free">r</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baliL.cases<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> keys_baliR<span class="main">:</span>
  <span class="quoted"><span class="quoted">"RBT_Impl.keys <span class="main">(</span>baliR <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> RBT_Impl.keys <span class="free">l</span> <span class="main">@</span> <span class="free">a</span> <span class="main">#</span> RBT_Impl.keys <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">a</span><span class="main">,</span><span class="free">r</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baliR.cases<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> keys_baldL<span class="main">:</span>
  <span class="quoted"><span class="quoted">"RBT_Impl.keys <span class="main">(</span>baldL <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> RBT_Impl.keys <span class="free">l</span> <span class="main">@</span> <span class="free">a</span> <span class="main">#</span> RBT_Impl.keys <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">a</span><span class="main">,</span><span class="free">r</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baldL.cases<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> keys_baliL keys_baliR keys_paint<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> keys_baldR<span class="main">:</span>
  <span class="quoted"><span class="quoted">"RBT_Impl.keys <span class="main">(</span>baldR <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> RBT_Impl.keys <span class="free">l</span> <span class="main">@</span> <span class="free">a</span> <span class="main">#</span> RBT_Impl.keys <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">a</span><span class="main">,</span><span class="free">r</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baldR.cases<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> keys_baliL keys_baliR keys_paint<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> keys_app<span class="main">:</span>
  <span class="quoted"><span class="quoted">"RBT_Impl.keys <span class="main">(</span>app <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> RBT_Impl.keys <span class="free">l</span> <span class="main">@</span> RBT_Impl.keys <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> app.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> keys_baldL keys_baldR
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> RBT_Impl.rbt.splits RBT_Impl.color.splits unit.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> keys_rbt_joinL<span class="main">:</span> <span class="quoted"><span class="quoted">"bheight <span class="free">l</span> <span class="main">≤</span> bheight <span class="free">r</span> <span class="main">⟹</span>
  RBT_Impl.keys <span class="main">(</span>rbt_joinL <span class="free">l</span> <span class="free">x</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> RBT_Impl.keys <span class="free">l</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> RBT_Impl.keys <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rbt_joinL.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">l</span> <span class="skolem">x</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> keys_baliL rbt_joinL.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> RBT_Impl.rbt.splits RBT_Impl.color.splits unit.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> keys_rbt_joinR<span class="main">:</span>
  <span class="quoted"><span class="quoted">"RBT_Impl.keys <span class="main">(</span>rbt_joinR <span class="free">l</span> <span class="free">x</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> RBT_Impl.keys <span class="free">l</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> RBT_Impl.keys <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rbt_joinR.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">l</span> <span class="skolem">x</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> keys_baliR rbt_joinR.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> RBT_Impl.rbt.splits RBT_Impl.color.splits unit.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_baliL<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>RBT_Impl.keys <span class="main">(</span>baliL <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">l</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">∪</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">a</span><span class="main">,</span><span class="free">r</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baliL.cases<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> set_rbt_joinL<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bheight <span class="free">l</span> <span class="main">≤</span> bheight <span class="free">r</span> <span class="main">⟹</span>
  set <span class="main">(</span>RBT_Impl.keys <span class="main">(</span>rbt_joinL <span class="free">l</span> <span class="free">x</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">l</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rbt_joinL.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">l</span> <span class="skolem">x</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_baliL rbt_joinL.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> RBT_Impl.rbt.splits RBT_Impl.color.splits unit.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_baliR<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>RBT_Impl.keys <span class="main">(</span>baliR <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">l</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">∪</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">a</span><span class="main">,</span><span class="free">r</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baliR.cases<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> set_rbt_joinR<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>RBT_Impl.keys <span class="main">(</span>rbt_joinR <span class="free">l</span> <span class="free">x</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">l</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rbt_joinR.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">l</span> <span class="skolem">x</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_baliR rbt_joinR.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> RBT_Impl.rbt.splits RBT_Impl.color.splits unit.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_paint<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>RBT_Impl.keys <span class="main">(</span>paint <span class="free">c</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> set_rbt_join<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>RBT_Impl.keys <span class="main">(</span>rbt_join <span class="free">l</span> <span class="free">x</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  set <span class="main">(</span>RBT_Impl.keys <span class="free">l</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_rbt_joinL set_rbt_joinR set_paint rbt_join_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inv_rbt_join<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> inv1 <span class="free">l</span><span class="main">;</span> inv2 <span class="free">l</span><span class="main">;</span> inv1 <span class="free">r</span><span class="main">;</span> inv2 <span class="free">r</span> <span class="main">⟧</span> <span class="main">⟹</span>
  inv1 <span class="main">(</span>rbt_join <span class="free">l</span> <span class="free">x</span> <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> inv2 <span class="main">(</span>rbt_join <span class="free">l</span> <span class="free">x</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rbt_join_def inv1l_rbt_joinL inv1l_rbt_joinR inv2_rbt_joinL inv2_rbt_joinR
      inv2_paint inv1_paint_B<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> color_of_rbt_join<span class="main">:</span> <span class="quoted"><span class="quoted">"color_of <span class="main">(</span>rbt_join <span class="free">l</span> <span class="free">x</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> color.B"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rbt_join_def color_of_paint_B<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rbt_join<span class="main">:</span> <span class="quoted"><span class="quoted">"rbt <span class="free">l</span> <span class="main">⟹</span> rbt <span class="free">r</span> <span class="main">⟹</span> rbt <span class="main">(</span>rbt_join <span class="free">l</span> <span class="free">x</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inv_rbt_join
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rbt_def color_of_rbt_join<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rbt_recolor</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> unit<span class="main">)</span> rbt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> unit<span class="main">)</span> rbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rbt_recolor</span> <span class="main">(</span>Branch RBT_Impl.R <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> color_of <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> RBT_Impl.B <span class="main">∧</span> color_of <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> RBT_Impl.B <span class="keyword1">then</span> Branch RBT_Impl.B <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span>
    <span class="keyword1">else</span> Branch RBT_Impl.R <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rbt_recolor</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rbt_recolor<span class="main">:</span> <span class="quoted"><span class="quoted">"rbt <span class="free">t</span> <span class="main">⟹</span> rbt <span class="main">(</span>rbt_recolor <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rbt_recolor.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rbt_def<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">split_min</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> urbt <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span> urbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">split_min</span> RBT_Impl.Empty <span class="main">=</span> undefined"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">split_min</span> <span class="main">(</span>RBT_Impl.Branch <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> is_empty <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">m</span><span class="main">,</span> <span class="bound">l'</span><span class="main">)</span> <span class="main">=</span> <span class="free">split_min</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">m</span><span class="main">,</span> rbt_join <span class="bound">l'</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> split_min_set<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> split_min <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="free">m</span><span class="main">,</span><span class="free">t'</span><span class="main">)</span><span class="main">;</span>  <span class="free">t</span> <span class="main">≠</span> RBT_Impl.Empty <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="free">m</span> <span class="main">∈</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">t</span><span class="main">)</span> <span class="main">∧</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">m</span><span class="main">}</span> <span class="main">∪</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t'</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_rbt_join <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> split_min_inv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> split_min <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="free">m</span><span class="main">,</span><span class="free">t'</span><span class="main">)</span><span class="main">;</span>  rbt <span class="free">t</span><span class="main">;</span>  <span class="free">t</span> <span class="main">≠</span> RBT_Impl.Empty <span class="main">⟧</span> <span class="main">⟹</span> rbt <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t'</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rbt_join <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> rbt_Node<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rbt_join2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> urbt <span class="main">⇒</span> <span class="tfree">'a</span> urbt <span class="main">⇒</span> <span class="tfree">'a</span> urbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rbt_join2</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> is_empty <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="keyword1">else</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">m</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">=</span> split_min <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">in</span> rbt_join <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="bound">m</span> <span class="bound">r'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_rbt_join2<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>RBT_Impl.keys <span class="main">(</span>rbt_join2 <span class="free">l</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">l</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rbt_join2_def split_min_set set_rbt_join <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> inv_rbt_join2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> rbt <span class="free">l</span><span class="main">;</span> rbt <span class="free">r</span> <span class="main">⟧</span> <span class="main">⟹</span> rbt <span class="main">(</span>rbt_join2 <span class="free">l</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rbt_join2_def rbt_join inv_rbt_join split_min_set split_min_inv <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> ord <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">split</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> urbt <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> urbt <span class="main">×</span> bool <span class="main">×</span> <span class="tfree">'a</span> urbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">split</span> RBT_Impl.Empty <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">(</span>RBT_Impl.Empty<span class="main">,</span> False<span class="main">,</span> RBT_Impl.Empty<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">split</span> <span class="main">(</span>RBT_Impl.Branch <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">()</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">split</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">l1</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">l2</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">l1</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> rbt_join <span class="bound">l2</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">split</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">r1</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">r2</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>rbt_join <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">r1</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">r2</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> True<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> split_rbt<span class="main">:</span> <span class="quoted"><span class="quoted">"split <span class="free">t</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">xin</span><span class="main">,</span><span class="free">r</span><span class="main">)</span> <span class="main">⟹</span> rbt <span class="free">t</span> <span class="main">⟹</span> rbt <span class="free">l</span> <span class="main">∧</span> rbt <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">xin</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_rbt_join rbt_join rbt_greater_prop rbt_less_prop
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rbt_Node<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> split_size<span class="main">:</span> <span class="quoted"><span class="quoted">"split <span class="free">t2</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="free">l2</span><span class="main">,</span> <span class="free">b</span><span class="main">,</span> <span class="free">r2</span><span class="main">)</span> <span class="main">⟹</span> size <span class="free">l2</span> <span class="main">+</span> size <span class="free">r2</span> <span class="main">≤</span> size <span class="free">t2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t2</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l2</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">r2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> split.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">union</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> urbt <span class="main">⇒</span> <span class="tfree">'a</span> urbt <span class="main">⇒</span> <span class="tfree">'a</span> urbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">union</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">t1</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">if</span> flip_rbt <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> small_rbt <span class="bound">t1</span> <span class="keyword1">then</span> RBT_Impl.fold rbt_insert <span class="bound">t1</span> <span class="bound">t2</span>
    <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">t2</span> <span class="keyword1">of</span> RBT_Impl.Empty <span class="main">⇒</span> <span class="bound">t1</span>
      <span class="main">|</span> RBT_Impl.Branch <span class="main"><span class="bound">_</span></span> <span class="bound">l2</span> <span class="bound">a</span> <span class="main">()</span> <span class="bound">r2</span> <span class="main">⇒</span>
        <span class="keyword1">case</span> split <span class="bound">t1</span> <span class="bound">a</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">l1</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">r1</span><span class="main">)</span> <span class="main">⇒</span> rbt_join <span class="main">(</span><span class="free">union</span> <span class="bound">l1</span> <span class="bound">l2</span><span class="main">)</span> <span class="bound">a</span> <span class="main">(</span><span class="free">union</span> <span class="bound">r1</span> <span class="bound">r2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t1</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span><span class="main">.</span> size <span class="bound">t1</span> <span class="main">+</span> size <span class="bound">t2</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add_leD1 le_imp_less_Suc ord.split_size trans_le_add2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add_leD1 le_imp_less_Suc ord.split_size trans_le_add1<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add_leD2 le_imp_less_Suc ord.split_size trans_le_add2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add_leD2 le_imp_less_Suc ord.split_size trans_le_add1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">declare</span></span> union.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> rbt_fold_rbt_insert<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rbt <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rbt <span class="main">(</span>RBT_Impl.fold rbt_insert <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> RBT_Impl.entries <span class="free">t1</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> RBT_Impl.fold_def xs_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rbt_def rbt_insert_def rbt_insert_with_key_def ins_inv1_inv2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rbt_union<span class="main">:</span> <span class="quoted"><span class="quoted">"rbt <span class="free">t1</span> <span class="main">⟹</span> rbt <span class="free">t2</span> <span class="main">⟹</span> rbt <span class="main">(</span>union <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">t2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> union.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> union.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">t1</span></span> <span class="quoted"><span class="skolem">t2</span></span><span class="main"><span class="main">]</span></span> rbt_join split_rbt rbt_fold_rbt_insert
        <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> RBT_Impl.rbt.splits RBT_Impl.color.splits unit.splits prod.split if_splits
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> rbt_Node<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">inter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> urbt <span class="main">⇒</span> <span class="tfree">'a</span> urbt <span class="main">⇒</span> <span class="tfree">'a</span> urbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inter</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">t1</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">if</span> flip_rbt <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> small_rbt <span class="bound">t1</span> <span class="keyword1">then</span>
      rbtreeify <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> rbt_lookup <span class="bound">t2</span> <span class="bound">k</span> <span class="main">=</span> Some <span class="main">()</span><span class="main">)</span> <span class="main">(</span>RBT_Impl.entries <span class="bound">t1</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">case</span> <span class="bound">t2</span> <span class="keyword1">of</span> RBT_Impl.Empty <span class="main">⇒</span> RBT_Impl.Empty
    <span class="main">|</span> RBT_Impl.Branch <span class="main"><span class="bound">_</span></span> <span class="bound">l2</span> <span class="bound">a</span> <span class="main">()</span> <span class="bound">r2</span> <span class="main">⇒</span>
      <span class="keyword1">case</span> split <span class="bound">t1</span> <span class="bound">a</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">l1</span><span class="main">,</span> <span class="bound">ain</span><span class="main">,</span> <span class="bound">r1</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">let</span> <span class="bound">l'</span> <span class="main">=</span> <span class="free">inter</span> <span class="bound">l1</span> <span class="bound">l2</span><span class="main">;</span> <span class="bound">r'</span> <span class="main">=</span> <span class="free">inter</span> <span class="bound">r1</span> <span class="bound">r2</span>
      <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">ain</span> <span class="keyword1">then</span> rbt_join <span class="bound">l'</span> <span class="bound">a</span> <span class="bound">r'</span> <span class="keyword1">else</span> rbt_join2 <span class="bound">l'</span> <span class="bound">r'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t1</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span><span class="main">.</span> size <span class="bound">t1</span> <span class="main">+</span> size <span class="bound">t2</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add_leD1 le_imp_less_Suc ord.split_size trans_le_add2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add_leD1 le_imp_less_Suc ord.split_size trans_le_add1<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add_leD2 le_imp_less_Suc ord.split_size trans_le_add2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add_leD2 le_imp_less_Suc ord.split_size trans_le_add1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">declare</span></span> inter.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> rbt_rbtreeify<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rbt <span class="main">(</span>rbtreeify <span class="free">kvs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rbt_def rbtreeify_def inv1_rbtreeify_g inv2_rbtreeify_g<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rbt_inter<span class="main">:</span> <span class="quoted"><span class="quoted">"rbt <span class="free">t1</span> <span class="main">⟹</span> rbt <span class="free">t2</span> <span class="main">⟹</span> rbt <span class="main">(</span>inter <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">t2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> inter.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inter.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">t1</span></span> <span class="quoted"><span class="skolem">t2</span></span><span class="main"><span class="main">]</span></span> inv_rbt_join inv_rbt_join2 split_rbt Let_def rbt_join
        <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> RBT_Impl.rbt.splits RBT_Impl.color.splits unit.splits prod.split if_splits
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rbt_Node<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">minus</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> urbt <span class="main">⇒</span> <span class="tfree">'a</span> urbt <span class="main">⇒</span> <span class="tfree">'a</span> urbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">minus</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> small_rbt <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="keyword1">then</span> RBT_Impl.fold <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="main"><span class="bound">_</span></span> <span class="bound">t</span><span class="main">.</span> rbt_delete <span class="bound">k</span> <span class="bound">t</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> small_rbt <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="keyword1">then</span>
      rbtreeify <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> rbt_lookup <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="bound">k</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">(</span>RBT_Impl.entries <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="keyword1">of</span> RBT_Impl.Empty <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span>
      <span class="main">|</span> RBT_Impl.Branch <span class="main"><span class="bound">_</span></span> <span class="bound">l2</span> <span class="bound">a</span> <span class="main">()</span> <span class="bound">r2</span> <span class="main">⇒</span>
        <span class="keyword1">case</span> split <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="bound">a</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">l1</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">r1</span><span class="main">)</span> <span class="main">⇒</span> rbt_join2 <span class="main">(</span><span class="free">minus</span> <span class="bound">l1</span> <span class="bound">l2</span><span class="main">)</span> <span class="main">(</span><span class="free">minus</span> <span class="bound">r1</span> <span class="bound">r2</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> minus.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> linorder <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rbt_delete<span class="main">:</span> <span class="quoted"><span class="quoted">"rbt <span class="free">t</span> <span class="main">⟹</span> rbt <span class="main">(</span>rbt_delete <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rbt_del_inv1_inv2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rbt_def rbt_delete_def rbt_del_inv1_inv2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rbt_fold_rbt_delete<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rbt <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rbt <span class="main">(</span>RBT_Impl.fold <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="main"><span class="bound">_</span></span> <span class="bound">t</span><span class="main">.</span> rbt_delete <span class="bound">k</span> <span class="bound">t</span><span class="main">)</span> <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> RBT_Impl.entries <span class="free">t1</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> RBT_Impl.fold_def xs_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rbt_delete<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rbt_minus<span class="main">:</span> <span class="quoted"><span class="quoted">"rbt <span class="free">t1</span> <span class="main">⟹</span> rbt <span class="free">t2</span> <span class="main">⟹</span> rbt <span class="main">(</span>minus <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">t2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> minus.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> minus.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">t1</span></span> <span class="quoted"><span class="skolem">t2</span></span><span class="main"><span class="main">]</span></span> inv_rbt_join inv_rbt_join2 split_rbt rbt_fold_rbt_delete
        <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> RBT_Impl.rbt.splits RBT_Impl.color.splits unit.splits prod.split if_splits
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> rbt_Node<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">comp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> comparator"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">split_comp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> urbt <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> urbt <span class="main">×</span> bool <span class="main">×</span> <span class="tfree">'a</span> urbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">split_comp</span> RBT_Impl.Empty <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="main">(</span>RBT_Impl.Empty<span class="main">,</span> False<span class="main">,</span> RBT_Impl.Empty<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">split_comp</span> <span class="main">(</span>RBT_Impl.Branch <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">()</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">comp</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">of</span>
    Lt <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">l1</span><span class="main">,</span><span class="bound">b</span><span class="main">,</span><span class="bound">l2</span><span class="main">)</span> <span class="main">=</span> <span class="free">split_comp</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">l1</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> rbt_join <span class="bound">l2</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> Gt <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">r1</span><span class="main">,</span><span class="bound">b</span><span class="main">,</span><span class="bound">r2</span><span class="main">)</span> <span class="main">=</span> <span class="free">split_comp</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">in</span> <span class="main">(</span>rbt_join <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">r1</span><span class="main">,</span> <span class="bound">b</span><span class="main">,</span> <span class="bound">r2</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> Eq <span class="main">⇒</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> True<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> split_comp_size<span class="main">:</span> <span class="quoted"><span class="quoted">"split_comp <span class="free">t2</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="free">l2</span><span class="main">,</span> <span class="free">b</span><span class="main">,</span> <span class="free">r2</span><span class="main">)</span> <span class="main">⟹</span> size <span class="free">l2</span> <span class="main">+</span> size <span class="free">r2</span> <span class="main">≤</span> size <span class="free">t2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t2</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l2</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">r2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> split_comp.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> order.splits if_splits prod.splits<span class="main">)</span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">union_comp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> urbt <span class="main">⇒</span> <span class="tfree">'a</span> urbt <span class="main">⇒</span> <span class="tfree">'a</span> urbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">union_comp</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">t1</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">if</span> flip_rbt <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> small_rbt <span class="bound">t1</span> <span class="keyword1">then</span> RBT_Impl.fold <span class="main">(</span>rbt_comp_insert <span class="free">comp</span><span class="main">)</span> <span class="bound">t1</span> <span class="bound">t2</span>
    <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">t2</span> <span class="keyword1">of</span> RBT_Impl.Empty <span class="main">⇒</span> <span class="bound">t1</span>
      <span class="main">|</span> RBT_Impl.Branch <span class="main"><span class="bound">_</span></span> <span class="bound">l2</span> <span class="bound">a</span> <span class="main">()</span> <span class="bound">r2</span> <span class="main">⇒</span>
        <span class="keyword1">case</span> split_comp <span class="bound">t1</span> <span class="bound">a</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">l1</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">r1</span><span class="main">)</span> <span class="main">⇒</span> rbt_join <span class="main">(</span><span class="free">union_comp</span> <span class="bound">l1</span> <span class="bound">l2</span><span class="main">)</span> <span class="bound">a</span> <span class="main">(</span><span class="free">union_comp</span> <span class="bound">r1</span> <span class="bound">r2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t1</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span><span class="main">.</span> size <span class="bound">t1</span> <span class="main">+</span> size <span class="bound">t2</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add_leD1 le_imp_less_Suc split_comp_size trans_le_add2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add_leD1 le_imp_less_Suc split_comp_size trans_le_add1<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add_leD2 le_imp_less_Suc split_comp_size trans_le_add2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add_leD2 le_imp_less_Suc split_comp_size trans_le_add1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">declare</span></span> union_comp.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">inter_comp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> urbt <span class="main">⇒</span> <span class="tfree">'a</span> urbt <span class="main">⇒</span> <span class="tfree">'a</span> urbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inter_comp</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">t1</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">if</span> flip_rbt <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> small_rbt <span class="bound">t1</span> <span class="keyword1">then</span>
      rbtreeify <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> rbt_comp_lookup <span class="free">comp</span> <span class="bound">t2</span> <span class="bound">k</span> <span class="main">=</span> Some <span class="main">()</span><span class="main">)</span> <span class="main">(</span>RBT_Impl.entries <span class="bound">t1</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">case</span> <span class="bound">t2</span> <span class="keyword1">of</span> RBT_Impl.Empty <span class="main">⇒</span> RBT_Impl.Empty
    <span class="main">|</span> RBT_Impl.Branch <span class="main"><span class="bound">_</span></span> <span class="bound">l2</span> <span class="bound">a</span> <span class="main">()</span> <span class="bound">r2</span> <span class="main">⇒</span>
      <span class="keyword1">case</span> split_comp <span class="bound">t1</span> <span class="bound">a</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">l1</span><span class="main">,</span> <span class="bound">ain</span><span class="main">,</span> <span class="bound">r1</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">let</span> <span class="bound">l'</span> <span class="main">=</span> <span class="free">inter_comp</span> <span class="bound">l1</span> <span class="bound">l2</span><span class="main">;</span> <span class="bound">r'</span> <span class="main">=</span> <span class="free">inter_comp</span> <span class="bound">r1</span> <span class="bound">r2</span>
      <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">ain</span> <span class="keyword1">then</span> rbt_join <span class="bound">l'</span> <span class="bound">a</span> <span class="bound">r'</span> <span class="keyword1">else</span> rbt_join2 <span class="bound">l'</span> <span class="bound">r'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">t1</span><span class="main">,</span> <span class="bound">t2</span><span class="main">)</span><span class="main">.</span> size <span class="bound">t1</span> <span class="main">+</span> size <span class="bound">t2</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add_leD1 le_imp_less_Suc split_comp_size trans_le_add2<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add_leD1 le_imp_less_Suc split_comp_size trans_le_add1<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add_leD2 le_imp_less_Suc split_comp_size trans_le_add2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add_leD2 le_imp_less_Suc split_comp_size trans_le_add1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">declare</span></span> inter_comp.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">minus_comp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> urbt <span class="main">⇒</span> <span class="tfree">'a</span> urbt <span class="main">⇒</span> <span class="tfree">'a</span> urbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">minus_comp</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> small_rbt <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="keyword1">then</span> RBT_Impl.fold <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="main"><span class="bound">_</span></span> <span class="bound">t</span><span class="main">.</span> rbt_comp_delete <span class="free">comp</span> <span class="bound">k</span> <span class="bound">t</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> small_rbt <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="keyword1">then</span>
      rbtreeify <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> rbt_comp_lookup <span class="free">comp</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="bound">k</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">(</span>RBT_Impl.entries <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="keyword1">of</span> RBT_Impl.Empty <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span>
      <span class="main">|</span> RBT_Impl.Branch <span class="main"><span class="bound">_</span></span> <span class="bound">l2</span> <span class="bound">a</span> <span class="main">()</span> <span class="bound">r2</span> <span class="main">⇒</span>
        <span class="keyword1">case</span> split_comp <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="bound">a</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">l1</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">r1</span><span class="main">)</span> <span class="main">⇒</span> rbt_join2 <span class="main">(</span><span class="free">minus_comp</span> <span class="bound">l1</span> <span class="bound">l2</span><span class="main">)</span> <span class="main">(</span><span class="free">minus_comp</span> <span class="bound">r1</span> <span class="bound">r2</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> minus_comp.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> comparator"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"comparator <span class="free">c</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">declare</span></span> comparator.le_lt_convs<span class="main">[</span><span class="operator">OF</span> c<span class="main">,</span> <span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">add</span></span></span></span></span></span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> anti_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"lt_of_comp <span class="free">c</span> <span class="free">a</span> <span class="free">x</span> <span class="main">⟹</span> lt_of_comp <span class="free">c</span> <span class="free">x</span> <span class="free">a</span> <span class="main">⟹</span> False"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> c comparator.Gt_lt_conv comparator.Lt_lt_conv order.distinct<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> split_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"split_comp <span class="free">c</span> <span class="free">t</span> <span class="free">x</span> <span class="main">=</span> ord.split <span class="main">(</span>lt_of_comp <span class="free">c</span><span class="main">)</span> <span class="free">t</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> split_comp.induct<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> comp<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ord.split.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> order.splits prod.splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> anti_sym<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> union_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"union_comp <span class="free">c</span> <span class="free">t1</span> <span class="free">t2</span> <span class="main">=</span> ord.union <span class="main">(</span>lt_of_comp <span class="free">c</span><span class="main">)</span> <span class="free">t1</span> <span class="free">t2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">t2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> union_comp.induct<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> comp<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t1'</span></span> <span class="skolem"><span class="skolem">t2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> flip<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t1'</span><span class="main">,</span> <span class="skolem">t2'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> flip_rbt <span class="skolem">t1</span> <span class="skolem">t2</span> <span class="keyword1">then</span> <span class="main">(</span><span class="skolem">t2</span><span class="main">,</span> <span class="skolem">t1</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t2'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Branch _ <span class="skolem">l2</span> <span class="skolem">a</span> <span class="skolem">u</span> <span class="skolem">r2</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> t1_not_Empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t2'</span> <span class="main">≠</span> RBT_Impl.Empty"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Branch<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> u_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> <span class="main">()</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l1</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">r1</span></span> <span class="keyword2"><span class="keyword">where</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"split_comp <span class="free">c</span> <span class="skolem">t1'</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l1</span><span class="main">,</span> <span class="skolem">b</span><span class="main">,</span> <span class="skolem">r1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"split_comp <span class="free">c</span> <span class="skolem">t1'</span> <span class="skolem">a</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 1<span class="main">[</span><span class="operator">OF</span> flip refl _ Branch<span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> union_comp.simps<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">t1</span></span><span class="main">]</span> ord.union.simps<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">t1</span></span><span class="main">]</span> flip<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Branch split split_comp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> rbt_comp_insert<span class="main"><span class="main">[</span></span><span class="operator">OF</span> c<span class="main"><span class="main">]</span></span>
          <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> unit.splits prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> union_comp.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">t1</span></span><span class="main"><span class="main">]</span></span> ord.union.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">t1</span></span><span class="main"><span class="main">]</span></span> flip<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
       rbt_comp_insert<span class="main"><span class="main">[</span></span><span class="operator">OF</span> c<span class="main"><span class="main">]</span></span> split_comp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> inter_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"inter_comp <span class="free">c</span> <span class="free">t1</span> <span class="free">t2</span> <span class="main">=</span> ord.inter <span class="main">(</span>lt_of_comp <span class="free">c</span><span class="main">)</span> <span class="free">t1</span> <span class="free">t2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">t2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> inter_comp.induct<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> comp<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t1'</span></span> <span class="skolem"><span class="skolem">t2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> flip<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t1'</span><span class="main">,</span> <span class="skolem">t2'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> flip_rbt <span class="skolem">t1</span> <span class="skolem">t2</span> <span class="keyword1">then</span> <span class="main">(</span><span class="skolem">t2</span><span class="main">,</span> <span class="skolem">t1</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t2'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Branch _ <span class="skolem">l2</span> <span class="skolem">a</span> <span class="skolem">u</span> <span class="skolem">r2</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> t1_not_Empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t2'</span> <span class="main">≠</span> RBT_Impl.Empty"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Branch<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> u_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> <span class="main">()</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l1</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">r1</span></span> <span class="keyword2"><span class="keyword">where</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"split_comp <span class="free">c</span> <span class="skolem">t1'</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l1</span><span class="main">,</span> <span class="skolem">b</span><span class="main">,</span> <span class="skolem">r1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"split_comp <span class="free">c</span> <span class="skolem">t1'</span> <span class="skolem">a</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 1<span class="main">[</span><span class="operator">OF</span> flip refl _ Branch<span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> inter_comp.simps<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">t1</span></span><span class="main">]</span> ord.inter.simps<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">t1</span></span><span class="main">]</span> flip<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Branch split split_comp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> rbt_comp_insert<span class="main"><span class="main">[</span></span><span class="operator">OF</span> c<span class="main"><span class="main">]</span></span> rbt_comp_lookup<span class="main"><span class="main">[</span></span><span class="operator">OF</span> c<span class="main"><span class="main">]</span></span>
          <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> unit.splits prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inter_comp.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">t1</span></span><span class="main"><span class="main">]</span></span> ord.inter.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">t1</span></span><span class="main"><span class="main">]</span></span> flip<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
       rbt_comp_insert<span class="main"><span class="main">[</span></span><span class="operator">OF</span> c<span class="main"><span class="main">]</span></span> rbt_comp_lookup<span class="main"><span class="main">[</span></span><span class="operator">OF</span> c<span class="main"><span class="main">]</span></span> split_comp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> minus_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"minus_comp <span class="free">c</span> <span class="free">t1</span> <span class="free">t2</span> <span class="main">=</span> ord.minus <span class="main">(</span>lt_of_comp <span class="free">c</span><span class="main">)</span> <span class="free">t1</span> <span class="free">t2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">t2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> minus_comp.induct<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> comp<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">c</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t2</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Branch _ <span class="skolem">l2</span> <span class="skolem">a</span> <span class="skolem">u</span> <span class="skolem">r2</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> t2_not_Empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t2</span> <span class="main">≠</span> RBT_Impl.Empty"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Branch<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> u_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> <span class="main">()</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l1</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">r1</span></span> <span class="keyword2"><span class="keyword">where</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"split_comp <span class="free">c</span> <span class="skolem">t1</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l1</span><span class="main">,</span> <span class="skolem">b</span><span class="main">,</span> <span class="skolem">r1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"split_comp <span class="free">c</span> <span class="skolem">t1</span> <span class="skolem">a</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 1<span class="main">[</span><span class="operator">OF</span> _ _ Branch<span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> minus_comp.simps<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">t1</span></span> <span class="quoted"><span class="skolem">t2</span></span><span class="main">]</span> ord.minus.simps<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">t1</span></span> <span class="quoted"><span class="skolem">t2</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Branch split split_comp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> rbt_comp_delete<span class="main"><span class="main">[</span></span><span class="operator">OF</span> c<span class="main"><span class="main">]</span></span> rbt_comp_lookup<span class="main"><span class="main">[</span></span><span class="operator">OF</span> c<span class="main"><span class="main">]</span></span>
          <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> unit.splits prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> minus_comp.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">t1</span></span><span class="main"><span class="main">]</span></span> ord.minus.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">t1</span></span><span class="main"><span class="main">]</span></span>
       rbt_comp_delete<span class="main"><span class="main">[</span></span><span class="operator">OF</span> c<span class="main"><span class="main">]</span></span> rbt_comp_lookup<span class="main"><span class="main">[</span></span><span class="operator">OF</span> c<span class="main"><span class="main">]</span></span> split_comp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> linorder <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rbt_sorted_baliL<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>rbt_sorted <span class="free">l</span><span class="main">;</span> rbt_sorted <span class="free">r</span><span class="main">;</span> <span class="free">l</span> <span class="main">|«</span> <span class="free">a</span><span class="main">;</span> <span class="free">a</span> <span class="main">«|</span> <span class="free">r</span><span class="main">⟧</span> <span class="main">⟹</span> rbt_sorted <span class="main">(</span>baliL <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rbt_greater_trans rbt_less_trans
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">a</span><span class="main">,</span><span class="free">r</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baliL.cases<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rbt_sorted_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> rbt_sorted_baliR<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>rbt_sorted <span class="free">l</span><span class="main">;</span> rbt_sorted <span class="free">r</span><span class="main">;</span> <span class="free">l</span> <span class="main">|«</span> <span class="free">a</span><span class="main">;</span> <span class="free">a</span> <span class="main">«|</span> <span class="free">r</span><span class="main">⟧</span> <span class="main">⟹</span> rbt_sorted <span class="main">(</span>baliR <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rbt_greater_trans rbt_less_trans
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">a</span><span class="main">,</span><span class="free">r</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baliR.cases<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rbt_sorted_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> rbt_sorted_rbt_joinL<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>rbt_sorted <span class="main">(</span>RBT_Impl.Branch <span class="free">c</span> <span class="free">l</span> <span class="free">a</span> <span class="main">()</span> <span class="free">r</span><span class="main">)</span><span class="main">;</span> bheight <span class="free">l</span> <span class="main">≤</span> bheight <span class="free">r</span><span class="main">⟧</span>
  <span class="main">⟹</span> rbt_sorted <span class="main">(</span>rbt_joinL <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rbt_joinL.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">l</span> <span class="skolem">a</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_baliL rbt_joinL.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="main">]</span></span> set_rbt_joinL rbt_less_prop
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rbt_sorted_baliL <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> RBT_Impl.rbt.splits RBT_Impl.color.splits unit.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rbt_sorted_rbt_joinR<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>rbt_sorted <span class="free">l</span><span class="main">;</span> rbt_sorted <span class="free">r</span><span class="main">;</span> <span class="free">l</span> <span class="main">|«</span> <span class="free">a</span><span class="main">;</span> <span class="free">a</span> <span class="main">«|</span> <span class="free">r</span><span class="main">⟧</span>
  <span class="main">⟹</span> rbt_sorted <span class="main">(</span>rbt_joinR <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rbt_joinR.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">l</span> <span class="skolem">a</span> <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_baliR rbt_joinR.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">r</span></span><span class="main"><span class="main">]</span></span> set_rbt_joinR rbt_greater_prop
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rbt_sorted_baliR <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> RBT_Impl.rbt.splits RBT_Impl.color.splits unit.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rbt_sorted_paint<span class="main">:</span> <span class="quoted"><span class="quoted">"rbt_sorted <span class="main">(</span>paint <span class="free">c</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> rbt_sorted <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> rbt_sorted_rbt_join<span class="main">:</span> <span class="quoted"><span class="quoted">"rbt_sorted <span class="main">(</span>RBT_Impl.Branch <span class="free">c</span> <span class="free">l</span> <span class="free">a</span> <span class="main">()</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span>
  rbt_sorted <span class="main">(</span>rbt_join <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rbt_sorted_paint rbt_sorted_rbt_joinL rbt_sorted_rbt_joinR rbt_join_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> split_min_rbt_sorted<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> split_min <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="free">m</span><span class="main">,</span><span class="free">t'</span><span class="main">)</span><span class="main">;</span>  rbt_sorted <span class="free">t</span><span class="main">;</span>  <span class="free">t</span> <span class="main">≠</span> RBT_Impl.Empty <span class="main">⟧</span> <span class="main">⟹</span>
  rbt_sorted <span class="free">t'</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">t'</span><span class="main">)</span><span class="main">.</span> <span class="free">m</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t'</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_min_set rbt_sorted_rbt_join set_rbt_join rbt_less_prop rbt_greater_prop
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rbt_sorted_rbt_join2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> rbt_sorted <span class="free">l</span><span class="main">;</span> rbt_sorted <span class="free">r</span><span class="main">;</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">l</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">r</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="bound">y</span> <span class="main">⟧</span>
  <span class="main">⟹</span> rbt_sorted <span class="main">(</span>rbt_join2 <span class="free">l</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rbt_join2_def rbt_sorted_rbt_join split_min_set split_min_rbt_sorted set_rbt_join
      rbt_greater_prop rbt_less_prop <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"split <span class="free">t</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">xin</span><span class="main">,</span><span class="free">r</span><span class="main">)</span> <span class="main">⟹</span> rbt_sorted <span class="free">t</span> <span class="main">⟹</span>
  set <span class="main">(</span>RBT_Impl.keys <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">t</span><span class="main">)</span><span class="main">.</span> <span class="bound">a</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">}</span> <span class="main">∧</span>
  set <span class="main">(</span>RBT_Impl.keys <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">t</span><span class="main">)</span><span class="main">.</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="bound">a</span><span class="main">}</span> <span class="main">∧</span>
  <span class="main">(</span><span class="free">xin</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> rbt_sorted <span class="free">l</span> <span class="main">∧</span> rbt_sorted <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">xin</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def set_rbt_join rbt_greater_prop rbt_less_prop
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rbt_sorted_rbt_join<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> keys_paint'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"RBT_Impl.keys <span class="main">(</span>RBT_Impl.paint <span class="free">c</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> RBT_Impl.keys <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>RBT_Impl.keys <span class="main">(</span>rbt_insert <span class="free">x</span> <span class="free">y</span> <span class="free">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">∪</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rbt_insert_def rbt_insert_with_key_def keys_ins<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_tree_fold_insert<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rbt_sorted <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>RBT_Impl.keys <span class="main">(</span>RBT_Impl.fold rbt_insert <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    set <span class="main">(</span>RBT_Impl.keys <span class="free">t1</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">t2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> RBT_Impl.entries <span class="free">t1</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> keys_t1<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>RBT_Impl.keys <span class="free">t1</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">`</span> set <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> xs_def RBT_Impl.keys_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> RBT_Impl.fold_def xs_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> keys_t1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rev_image_eqI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rbt_sorted_union<span class="main">:</span> <span class="quoted"><span class="quoted">"rbt_sorted <span class="free">t1</span> <span class="main">⟹</span> rbt_sorted <span class="free">t2</span> <span class="main">⟹</span>
  set <span class="main">(</span>RBT_Impl.keys <span class="main">(</span>union <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">t1</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">t2</span><span class="main">)</span> <span class="main">∧</span>
  rbt_sorted <span class="main">(</span>union <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">t2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> union.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t1'</span></span> <span class="skolem"><span class="skolem">t2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> flip<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t1'</span><span class="main">,</span> <span class="skolem">t2'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> flip_rbt <span class="skolem">t1</span> <span class="skolem">t2</span> <span class="keyword1">then</span> <span class="main">(</span><span class="skolem">t2</span><span class="main">,</span> <span class="skolem">t1</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> set_flip<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t1</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span>
      set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t1'</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t2'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> flip
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> rbt_sorted'<span class="main">:</span> <span class="quoted"><span class="quoted">"rbt_sorted <span class="skolem">t1'</span>"</span></span> <span class="quoted"><span class="quoted">"rbt_sorted <span class="skolem">t2'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> flip
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t2'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Branch _ <span class="skolem">l2</span> <span class="skolem">a</span> <span class="skolem">u</span> <span class="skolem">r2</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l1</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">r1</span></span> <span class="keyword2"><span class="keyword">where</span></span> split_t1'<span class="main">:</span> <span class="quoted"><span class="quoted">"split <span class="skolem">t1'</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l1</span><span class="main">,</span> <span class="skolem">b</span><span class="main">,</span> <span class="skolem">r1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"split <span class="skolem">t1'</span> <span class="skolem">a</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> rbt_sort<span class="main">:</span> <span class="quoted"><span class="quoted">"rbt_sorted <span class="skolem">l2</span>"</span></span> <span class="quoted"><span class="quoted">"rbt_sorted <span class="skolem">r2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> flip
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Branch <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> split_t1'_prop <span class="main">=</span> split<span class="main">[</span><span class="operator">OF</span> split_t1' rbt_sorted'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> union_l1_l2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>small_rbt <span class="skolem">t1'</span> <span class="main">⟹</span>
      set <span class="main">(</span>RBT_Impl.keys <span class="main">(</span>union <span class="skolem">l1</span> <span class="skolem">l2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>RBT_Impl.keys <span class="skolem">l1</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>RBT_Impl.keys <span class="skolem">l2</span><span class="main">)</span> <span class="main">∧</span>
      rbt_sorted <span class="main">(</span>union <span class="skolem">l1</span> <span class="skolem">l2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> flip _ _ Branch _ split_t1'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span> rbt_sort split_t1'_prop
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> union_r1_r2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>small_rbt <span class="skolem">t1'</span> <span class="main">⟹</span>
      set <span class="main">(</span>RBT_Impl.keys <span class="main">(</span>union <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>RBT_Impl.keys <span class="skolem">r1</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>RBT_Impl.keys <span class="skolem">r2</span><span class="main">)</span> <span class="main">∧</span>
      rbt_sorted <span class="main">(</span>union <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> flip _ _ Branch _ split_t1'<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span> rbt_sort split_t1'_prop
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>RBT_Impl.keys <span class="main">(</span>union <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t1</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rbt_sorted' union_l1_l2 union_r1_r2 split_t1'_prop
      <span class="keyword1"><span class="command">unfolding</span></span> set_flip
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 0 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> union.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">t1</span></span><span class="main"><span class="main">]</span></span> flip<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> set_tree_fold_insert<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Branch split_t1' set_rbt_join <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> unit.splits if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rbt_sorted <span class="main">(</span>union <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rbt_sorted' 1<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> union_l1_l2 union_r1_r2 split_t1'_prop
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 0 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> union.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">t1</span></span><span class="main"><span class="main">]</span></span> flip<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> rbt_sorted_fold_insert<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Branch split_t1' rbt_less_prop rbt_greater_prop <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rbt_sorted_rbt_join
          <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> unit.splits if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_flip union.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">t1</span></span><span class="main"><span class="main">]</span></span> flip<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> set_tree_fold_insert
       <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rbt_sorted_fold_insert<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rbt_sorted_rbtreeify<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rbt_sorted <span class="free">t</span> <span class="main">⟹</span> rbt_sorted <span class="main">(</span>rbtreeify <span class="main">(</span>filter <span class="free">P</span> <span class="main">(</span>RBT_Impl.entries <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> distinct_map_filterI distinct_entries rbt_sorted_entries rbt_sorted_rbtreeify sorted_filter
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> rbtreeify_keys_Some<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rbt_sorted <span class="free">t1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>RBT_Impl.keys <span class="main">(</span>rbtreeify <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> rbt_lookup <span class="free">t1</span> <span class="bound">k</span> <span class="main">=</span> Some <span class="main">()</span><span class="main">)</span>
  <span class="main">(</span>RBT_Impl.entries <span class="free">t2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">t1</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> RBT_Impl.keys_def map_of_entries<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> map_of_eq_None_iff not_None_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> image_iff weak_map_of_SomeI
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> rbt_sorted_inter<span class="main">:</span> <span class="quoted"><span class="quoted">"rbt_sorted <span class="free">t1</span> <span class="main">⟹</span> rbt_sorted <span class="free">t2</span> <span class="main">⟹</span>
  set <span class="main">(</span>RBT_Impl.keys <span class="main">(</span>inter <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">t1</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">t2</span><span class="main">)</span> <span class="main">∧</span>
  rbt_sorted <span class="main">(</span>inter <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">t2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> inter.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t1'</span></span> <span class="skolem"><span class="skolem">t2'</span></span> <span class="keyword2"><span class="keyword">where</span></span> flip<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t1'</span><span class="main">,</span> <span class="skolem">t2'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> flip_rbt <span class="skolem">t1</span> <span class="skolem">t2</span> <span class="keyword1">then</span> <span class="main">(</span><span class="skolem">t2</span><span class="main">,</span> <span class="skolem">t1</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="skolem">t1</span><span class="main">,</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> set_flip<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t1</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span>
    set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t1'</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t2'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> flip
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> rbt_sorted'<span class="main">:</span> <span class="quoted"><span class="quoted">"rbt_sorted <span class="skolem">t1'</span>"</span></span> <span class="quoted"><span class="quoted">"rbt_sorted <span class="skolem">t2'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> flip
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t2'</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>Branch _ <span class="skolem">l2</span> <span class="skolem">a</span> <span class="skolem">u</span> <span class="skolem">r2</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> set_flip<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t1</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span>
      set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t1'</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t2'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> flip
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l1</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">r1</span></span> <span class="keyword2"><span class="keyword">where</span></span> sp<span class="main">:</span> <span class="quoted"><span class="quoted">"split <span class="skolem">t1'</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l1</span><span class="main">,</span> <span class="skolem">b</span><span class="main">,</span> <span class="skolem">r1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"split <span class="skolem">t1'</span> <span class="skolem">a</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> rbt_sort<span class="main">:</span> <span class="quoted"><span class="quoted">"rbt_sorted <span class="skolem">l2</span>"</span></span> <span class="quoted"><span class="quoted">"rbt_sorted <span class="skolem">r2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> flip
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> split_t1'_prop <span class="main">=</span> split<span class="main">[</span><span class="operator">OF</span> sp rbt_sorted'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> inter_l1_l2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>small_rbt <span class="skolem">t1'</span> <span class="main">⟹</span>
      set <span class="main">(</span>RBT_Impl.keys <span class="main">(</span>inter <span class="skolem">l1</span> <span class="skolem">l2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>RBT_Impl.keys <span class="skolem">l1</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>RBT_Impl.keys <span class="skolem">l2</span><span class="main">)</span> <span class="main">∧</span>
      rbt_sorted <span class="main">(</span>inter <span class="skolem">l1</span> <span class="skolem">l2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> flip _ _ Branch _ sp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span> rbt_sort split_t1'_prop
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> inter_r1_r2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>small_rbt <span class="skolem">t1'</span> <span class="main">⟹</span>
      set <span class="main">(</span>RBT_Impl.keys <span class="main">(</span>inter <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>RBT_Impl.keys <span class="skolem">r1</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>RBT_Impl.keys <span class="skolem">r2</span><span class="main">)</span> <span class="main">∧</span>
      rbt_sorted <span class="main">(</span>inter <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> flip _ _ Branch _ sp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span> rbt_sort split_t1'_prop
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> not_small<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>small_rbt <span class="skolem">t1'</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?L2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>RBT_Impl.keys <span class="skolem">l2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>RBT_Impl.keys <span class="skolem">r2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> <span class="var">?L2</span> <span class="main">∪</span> <span class="var">?R2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹rbt_sorted <span class="skolem">t2'</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rbt_less_prop rbt_greater_prop<span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?L1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>RBT_Impl.keys <span class="skolem">l1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>RBT_Impl.keys <span class="skolem">r1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?K</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> <span class="skolem">b</span> <span class="keyword1">then</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> t2<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t1'</span><span class="main">)</span> <span class="main">=</span> <span class="var">?L1</span> <span class="main">∪</span> <span class="var">?R1</span> <span class="main">∪</span> <span class="var">?K</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?L1</span> <span class="main">∩</span> <span class="var">?R1</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> <span class="var">?L1</span> <span class="main">∪</span> <span class="var">?R1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L2</span> <span class="main">∩</span> <span class="var">?R1</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L1</span> <span class="main">∩</span> <span class="var">?R2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> split<span class="main">[</span><span class="operator">OF</span> sp<span class="main">]</span> less_linear <span class="quoted"><span class="quoted">‹rbt_sorted <span class="skolem">t1'</span>›</span></span> <span class="quoted"><span class="quoted">‹rbt_sorted <span class="skolem">t2'</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rbt_less_prop rbt_greater_prop<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t1'</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t2'</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span><span class="var">?L2</span> <span class="main">∪</span> <span class="var">?R2</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="var">?L1</span> <span class="main">∪</span> <span class="var">?R1</span> <span class="main">∪</span> <span class="var">?K</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t2<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="var">?L1</span> <span class="main">∩</span> <span class="var">?L2</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="var">?R1</span> <span class="main">∩</span> <span class="var">?R2</span><span class="main">)</span> <span class="main">∪</span> <span class="var">?K</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> * ** <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> set <span class="main">(</span>RBT_Impl.keys <span class="main">(</span>inter <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> inter_l1_l2<span class="main">[</span><span class="operator">OF</span> not_small<span class="main">]</span> inter_r1_r2<span class="main">[</span><span class="operator">OF</span> not_small<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inter.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">t1</span></span><span class="main"><span class="main">]</span></span> flip<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> not_small sp set_rbt_join
            <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> unit.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>RBT_Impl.keys <span class="main">(</span>inter <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t1</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> set_flip
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"small_rbt <span class="skolem">t1'</span> <span class="main">⟹</span> set <span class="main">(</span>RBT_Impl.keys <span class="main">(</span>inter <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      set <span class="main">(</span>RBT_Impl.keys <span class="main">(</span>rbtreeify <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> rbt_lookup <span class="skolem">t2'</span> <span class="bound">k</span> <span class="main">=</span> Some <span class="main">()</span><span class="main">)</span>
      <span class="main">(</span>RBT_Impl.entries <span class="skolem">t1'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inter.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">t1</span></span><span class="main"><span class="main">]</span></span> flip<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>RBT_Impl.keys <span class="main">(</span>ord_class.inter <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t1</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> flip
      <span class="keyword1"><span class="command">unfolding</span></span> rbtreeify_keys_Some<span class="main">[</span><span class="operator">OF</span> rbt_sorted'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> set_flip
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rbt_sorted <span class="main">(</span>inter <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rbt_sorted'<span class="main">(</span>1<span class="main">)</span> rbt_sort 1<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> inter_l1_l2 inter_r1_r2 split_t1'_prop
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 0 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inter.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">t1</span></span><span class="main"><span class="main">]</span></span> flip<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> sp rbt_less_prop rbt_greater_prop
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rbt_sorted_rbtreeify rbt_sorted_rbt_join rbt_sorted_rbt_join2
          <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> unit.splits if_splits<span class="main">)</span>
         <span class="main">(</span><span class="operator">meson</span> local.order.strict_trans<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rbtreeify_def set_flip inter.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">t1</span></span><span class="main"><span class="main">]</span></span> flip<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"RBT_Impl.entries <span class="main">(</span>RBT_Impl.paint <span class="free">c</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> RBT_Impl.entries <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rbt <span class="free">t</span> <span class="main">⟹</span> rbt_sorted <span class="free">t</span> <span class="main">⟹</span>
  set <span class="main">(</span>RBT_Impl.keys <span class="main">(</span>rbt_delete <span class="free">x</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">t</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rbt_del_in_tree image_iff
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rbt_def RBT_Impl.keys_def rbt_delete_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"rbt_sorted <span class="free">t</span> <span class="main">⟹</span> rbt_sorted <span class="main">(</span>rbt_delete <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rbt_delete_def rbt_del_rbt_sorted<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fold_rbt_delete<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rbt <span class="free">t2</span>"</span></span> <span class="quoted"><span class="quoted">"rbt_sorted <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>RBT_Impl.keys <span class="main">(</span>RBT_Impl.fold <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="main"><span class="bound">_</span></span> <span class="bound">t</span><span class="main">.</span> rbt_delete <span class="bound">k</span> <span class="bound">t</span><span class="main">)</span> <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    set <span class="main">(</span>RBT_Impl.keys <span class="free">t2</span><span class="main">)</span> <span class="main">-</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">t1</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"rbt <span class="main">(</span>RBT_Impl.fold <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="main"><span class="bound">_</span></span> <span class="bound">t</span><span class="main">.</span> rbt_delete <span class="bound">k</span> <span class="bound">t</span><span class="main">)</span> <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"rbt_sorted <span class="main">(</span>RBT_Impl.fold <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="main"><span class="bound">_</span></span> <span class="bound">t</span><span class="main">.</span> rbt_delete <span class="bound">k</span> <span class="bound">t</span><span class="main">)</span> <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> RBT_Impl.entries <span class="free">t1</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> keys_t1<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>RBT_Impl.keys <span class="free">t1</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">`</span> set <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> xs_def RBT_Impl.keys_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"set <span class="main">(</span>RBT_Impl.keys <span class="main">(</span>RBT_Impl.fold <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="main"><span class="bound">_</span></span> <span class="bound">t</span><span class="main">.</span> rbt_delete <span class="bound">k</span> <span class="bound">t</span><span class="main">)</span> <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    set <span class="main">(</span>RBT_Impl.keys <span class="free">t2</span><span class="main">)</span> <span class="main">-</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">t1</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"rbt <span class="main">(</span>RBT_Impl.fold <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="main"><span class="bound">_</span></span> <span class="bound">t</span><span class="main">.</span> rbt_delete <span class="bound">k</span> <span class="bound">t</span><span class="main">)</span> <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"rbt_sorted <span class="main">(</span>RBT_Impl.fold <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="main"><span class="bound">_</span></span> <span class="bound">t</span><span class="main">.</span> rbt_delete <span class="bound">k</span> <span class="bound">t</span><span class="main">)</span> <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> RBT_Impl.fold_def xs_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> keys_t1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rev_image_eqI rbt_delete rbt_del_rbt_sorted<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rbt_sorted_fold_delete<span class="main">:</span> <span class="quoted"><span class="quoted">"rbt_sorted <span class="free">t</span> <span class="main">⟹</span>
  rbt_sorted <span class="main">(</span>RBT_Impl.fold <span class="main">(</span><span class="main">λ</span><span class="bound">k</span> <span class="main"><span class="bound">_</span></span> <span class="bound">t</span><span class="main">.</span> rbt_delete <span class="bound">k</span> <span class="bound">t</span><span class="main">)</span> <span class="free">t'</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">t'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> rbtreeify_keys_None<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rbt_sorted <span class="free">t1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>RBT_Impl.keys <span class="main">(</span>rbtreeify <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> rbt_lookup <span class="free">t1</span> <span class="bound">k</span> <span class="main">=</span> None<span class="main">)</span>
  <span class="main">(</span>RBT_Impl.entries <span class="free">t2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">t2</span><span class="main">)</span> <span class="main">-</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">t1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> RBT_Impl.keys_def map_of_entries<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> image_iff weak_map_of_SomeI
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">smt</span> fst_conv image_iff map_of_eq_None_iff mem_Collect_eq<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> rbt_sorted_minus<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rbt <span class="free">t1</span> <span class="main">⟹</span> rbt_sorted <span class="free">t1</span> <span class="main">⟹</span> rbt_sorted <span class="free">t2</span> <span class="main">⟹</span>
  set <span class="main">(</span>RBT_Impl.keys <span class="main">(</span>minus <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">t1</span><span class="main">)</span> <span class="main">-</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">t2</span><span class="main">)</span> <span class="main">∧</span>
  rbt_sorted <span class="main">(</span>minus <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t1</span></span> <span class="quoted"><span class="free">t2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> minus.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t2</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Empty
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> minus.simps rbtreeify_keys_None <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rbt_sorted_rbtreeify<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Empty<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>Branch _ <span class="skolem">l2</span> <span class="skolem">a</span> _ <span class="skolem">r2</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?L2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>RBT_Impl.keys <span class="skolem">l2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>RBT_Impl.keys <span class="skolem">r2</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l1</span></span> <span class="skolem"><span class="skolem">ain</span></span> <span class="skolem"><span class="skolem">r1</span></span> <span class="keyword2"><span class="keyword">where</span></span> sp<span class="main">:</span> <span class="quoted"><span class="quoted">"split <span class="skolem">t1</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">l1</span><span class="main">,</span><span class="skolem">ain</span><span class="main">,</span><span class="skolem">r1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prod_cases3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?L1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>RBT_Impl.keys <span class="skolem">l1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>RBT_Impl.keys <span class="skolem">r1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?K</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> <span class="skolem">ain</span> <span class="keyword1">then</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> rbt_l1_r1<span class="main">:</span> <span class="quoted"><span class="quoted">"rbt <span class="skolem">l1</span>"</span></span> <span class="quoted"><span class="quoted">"rbt <span class="skolem">r1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> split_rbt<span class="main">[</span><span class="operator">OF</span> sp 1<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> t1<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t1</span><span class="main">)</span> <span class="main">=</span> <span class="var">?L1</span> <span class="main">∪</span> <span class="var">?R1</span> <span class="main">∪</span> <span class="var">?K</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∉</span> <span class="var">?L1</span> <span class="main">∪</span> <span class="var">?R1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L1</span> <span class="main">∩</span> <span class="var">?R2</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L2</span> <span class="main">∩</span> <span class="var">?R1</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> split<span class="main">[</span><span class="operator">OF</span> sp<span class="main">]</span> less_linear <span class="quoted"><span class="quoted">‹rbt_sorted <span class="skolem">t1</span>›</span></span> <span class="quoted"><span class="quoted">‹rbt_sorted <span class="skolem">t2</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rbt_less_prop rbt_greater_prop<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> IHl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> small_rbt <span class="skolem">t1</span> <span class="main">⟹</span> <span class="main">¬</span>small_rbt <span class="skolem">t2</span> <span class="main">⟹</span> set <span class="main">(</span>RBT_Impl.keys <span class="main">(</span>minus <span class="skolem">l1</span> <span class="skolem">l2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      set <span class="main">(</span>RBT_Impl.keys <span class="skolem">l1</span><span class="main">)</span> <span class="main">-</span> set <span class="main">(</span>RBT_Impl.keys <span class="skolem">l2</span><span class="main">)</span> <span class="main">∧</span> rbt_sorted <span class="main">(</span>minus <span class="skolem">l1</span> <span class="skolem">l2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span><span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ _ _ _ sp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">)</span> split<span class="main">[</span><span class="operator">OF</span> sp<span class="main">]</span> rbt_l1_r1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> IHr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> small_rbt <span class="skolem">t1</span> <span class="main">⟹</span> <span class="main">¬</span>small_rbt <span class="skolem">t2</span> <span class="main">⟹</span> set <span class="main">(</span>RBT_Impl.keys <span class="main">(</span>minus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      set <span class="main">(</span>RBT_Impl.keys <span class="skolem">r1</span><span class="main">)</span> <span class="main">-</span> set <span class="main">(</span>RBT_Impl.keys <span class="skolem">r2</span><span class="main">)</span> <span class="main">∧</span> rbt_sorted <span class="main">(</span>minus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span><span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ _ _ _ sp<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">)</span> split<span class="main">[</span><span class="operator">OF</span> sp<span class="main">]</span> rbt_l1_r1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>small_rbt <span class="skolem">t1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>small_rbt <span class="skolem">t2</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t1</span><span class="main">)</span> <span class="main">-</span> set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="var">?L1</span> <span class="main">∪</span> <span class="var">?R1</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="var">?L2</span> <span class="main">∪</span> <span class="var">?R2</span>  <span class="main">∪</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t1<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="var">?L1</span> <span class="main">-</span> <span class="var">?L2</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="var">?R1</span> <span class="main">-</span> <span class="var">?R2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ** <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> set <span class="main">(</span>RBT_Impl.keys <span class="main">(</span>minus <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> IH
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> minus.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">t1</span></span><span class="main"><span class="main">]</span></span> sp IHl IHr <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> unit.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"set <span class="main">(</span>RBT_Impl.keys <span class="main">(</span>minus <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t1</span><span class="main">)</span> <span class="main">-</span> set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t2</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>RBT_Impl.keys <span class="main">(</span>ord_class.minus <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t1</span><span class="main">)</span> <span class="main">-</span> set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> fold_rbt_delete
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> minus.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">t1</span></span><span class="main"><span class="main">]</span></span> sp rbtreeify_keys_None<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 1<span class="main"><span class="main"><span class="main">(</span></span></span>5<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> Branch<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rbt_sorted <span class="main">(</span>minus <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>3<span class="main">,</span>4<span class="main">,</span>5<span class="main">)</span> IHl IHr split<span class="main">[</span><span class="operator">OF</span> sp 1<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> minus.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">t1</span></span><span class="main"><span class="main">]</span></span> sp rbt_less_prop rbt_greater_prop rbt_sorted_fold_delete
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rbt_sorted_rbtreeify rbt_sorted_rbt_join rbt_sorted_rbt_join2
          <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> unit.splits if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_rbt_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> urbt <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">is_rbt_aux</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟷</span> inv1 <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> inv2 <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> rbt_sorted <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_rbt_aux_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"is_rbt_aux <span class="free">t</span> <span class="main">⟷</span> rbt <span class="free">t</span> <span class="main">∧</span> rbt_sorted <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_rbt_aux_def rbt_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_rbt_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"is_rbt <span class="free">t</span> <span class="main">⟷</span> is_rbt_aux <span class="free">t</span> <span class="main">∧</span> color_of <span class="free">t</span> <span class="main">=</span> RBT_Impl.B"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_rbt_def is_rbt_aux_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_rbt_aux_union<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> is_rbt_aux <span class="free">t1</span><span class="main">;</span> is_rbt_aux <span class="free">t2</span> <span class="main">⟧</span> <span class="main">⟹</span> is_rbt_aux <span class="main">(</span>union <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rbt_sorted_union rbt_union
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_rbt_aux_prop<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_rbt_aux_inter<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> is_rbt_aux <span class="free">t1</span><span class="main">;</span> is_rbt_aux <span class="free">t2</span> <span class="main">⟧</span> <span class="main">⟹</span> is_rbt_aux <span class="main">(</span>inter <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rbt_sorted_inter rbt_inter
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_rbt_aux_prop<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_rbt_aux_minus<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> is_rbt_aux <span class="free">t1</span><span class="main">;</span> is_rbt_aux <span class="free">t2</span> <span class="main">⟧</span> <span class="main">⟹</span> is_rbt_aux <span class="main">(</span>minus <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rbt_sorted_minus rbt_minus
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_rbt_aux_prop<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rbt_sorted_recolor<span class="main">:</span> <span class="quoted"><span class="quoted">"rbt_sorted <span class="free">t</span> <span class="main">⟹</span> rbt_sorted <span class="main">(</span>rbt_recolor <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rbt_recolor.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> color_of_rbt_recolor<span class="main">:</span> <span class="quoted"><span class="quoted">"is_rbt_aux <span class="free">t</span> <span class="main">⟹</span> color_of <span class="main">(</span>rbt_recolor <span class="free">t</span><span class="main">)</span> <span class="main">=</span> color.B"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rbt_recolor.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_rbt_aux_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_rbt_recolor<span class="main">:</span> <span class="quoted"><span class="quoted">"is_rbt_aux <span class="free">t</span> <span class="main">⟹</span> is_rbt <span class="main">(</span>rbt_recolor <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> color_of_rbt_recolor rbt_recolor rbt_sorted_recolor
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_rbt_prop is_rbt_aux_prop<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_rbt_dest<span class="main">:</span> <span class="quoted"><span class="quoted">"is_rbt <span class="free">t</span> <span class="main">⟹</span> is_rbt_aux <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_rbt_prop<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_rbt_union<span class="main">:</span> <span class="quoted"><span class="quoted">"is_rbt <span class="free">t1</span> <span class="main">⟹</span> is_rbt <span class="free">t2</span> <span class="main">⟹</span> is_rbt <span class="main">(</span>rbt_recolor <span class="main">(</span>union <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> is_rbt_aux_union
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> is_rbt_dest <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> is_rbt_recolor<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_rbt_inter<span class="main">:</span> <span class="quoted"><span class="quoted">"is_rbt <span class="free">t1</span> <span class="main">⟹</span> is_rbt <span class="free">t2</span> <span class="main">⟹</span> is_rbt <span class="main">(</span>rbt_recolor <span class="main">(</span>inter <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> is_rbt_aux_inter
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> is_rbt_dest <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> is_rbt_recolor<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_rbt_minus<span class="main">:</span> <span class="quoted"><span class="quoted">"is_rbt <span class="free">t1</span> <span class="main">⟹</span> is_rbt <span class="free">t2</span> <span class="main">⟹</span> is_rbt <span class="main">(</span>rbt_recolor <span class="main">(</span>minus <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> is_rbt_aux_minus
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> is_rbt_dest <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> is_rbt_recolor<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_rbt_union_comp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ID ccompare <span class="main">=</span> Some <span class="main">(</span><span class="free">c</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> ccompare<span class="main">)</span> comparator<span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"ord.is_rbt <span class="main">(</span>lt_of_comp <span class="free">c</span><span class="main">)</span> <span class="free">t1</span>"</span></span> <span class="quoted"><span class="quoted">"ord.is_rbt <span class="main">(</span>lt_of_comp <span class="free">c</span><span class="main">)</span> <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ord.is_rbt <span class="main">(</span>lt_of_comp <span class="free">c</span><span class="main">)</span> <span class="main">(</span>rbt_recolor <span class="main">(</span>union_comp <span class="free">c</span> <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> linorder.is_rbt_union<span class="main">[</span><span class="operator">OF</span> ID_ccompare<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
    union_comp<span class="main">[</span><span class="operator">OF</span> ID_ccompare'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lift_definition</span></span> rbt_union_rbt_join2 <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> ccompare set_rbt <span class="main">⇒</span> <span class="tfree">'a</span> set_rbt <span class="main">⇒</span> <span class="tfree">'a</span> set_rbt"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t1</span> <span class="bound">t2</span><span class="main">.</span> rbt_recolor <span class="main">(</span>union_comp ccomp <span class="bound">t1</span> <span class="bound">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> is_rbt_union_comp
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> is_rbt_inter_comp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ID ccompare <span class="main">=</span> Some <span class="main">(</span><span class="free">c</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> ccompare<span class="main">)</span> comparator<span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"ord.is_rbt <span class="main">(</span>lt_of_comp <span class="free">c</span><span class="main">)</span> <span class="free">t1</span>"</span></span> <span class="quoted"><span class="quoted">"ord.is_rbt <span class="main">(</span>lt_of_comp <span class="free">c</span><span class="main">)</span> <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ord.is_rbt <span class="main">(</span>lt_of_comp <span class="free">c</span><span class="main">)</span> <span class="main">(</span>rbt_recolor <span class="main">(</span>inter_comp <span class="free">c</span> <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> linorder.is_rbt_inter<span class="main">[</span><span class="operator">OF</span> ID_ccompare<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
    inter_comp<span class="main">[</span><span class="operator">OF</span> ID_ccompare'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lift_definition</span></span> rbt_inter_rbt_join2 <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> ccompare set_rbt <span class="main">⇒</span> <span class="tfree">'a</span> set_rbt <span class="main">⇒</span> <span class="tfree">'a</span> set_rbt"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t1</span> <span class="bound">t2</span><span class="main">.</span> rbt_recolor <span class="main">(</span>inter_comp ccomp <span class="bound">t1</span> <span class="bound">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> is_rbt_inter_comp
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> is_rbt_minus_comp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ID ccompare <span class="main">=</span> Some <span class="main">(</span><span class="free">c</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> ccompare<span class="main">)</span> comparator<span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"ord.is_rbt <span class="main">(</span>lt_of_comp <span class="free">c</span><span class="main">)</span> <span class="free">t1</span>"</span></span> <span class="quoted"><span class="quoted">"ord.is_rbt <span class="main">(</span>lt_of_comp <span class="free">c</span><span class="main">)</span> <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ord.is_rbt <span class="main">(</span>lt_of_comp <span class="free">c</span><span class="main">)</span> <span class="main">(</span>rbt_recolor <span class="main">(</span>minus_comp <span class="free">c</span> <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> linorder.is_rbt_minus<span class="main">[</span><span class="operator">OF</span> ID_ccompare<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
    minus_comp<span class="main">[</span><span class="operator">OF</span> ID_ccompare'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lift_definition</span></span> rbt_minus_rbt_join2 <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> ccompare set_rbt <span class="main">⇒</span> <span class="tfree">'a</span> set_rbt <span class="main">⇒</span> <span class="tfree">'a</span> set_rbt"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t1</span> <span class="bound">t2</span><span class="main">.</span> rbt_recolor <span class="main">(</span>minus_comp ccomp <span class="bound">t1</span> <span class="bound">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> is_rbt_minus_comp
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> rbt_recolor_keys<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>RBT_Impl.keys <span class="main">(</span>rbt_recolor <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rbt_recolor.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> rbt_union_rbt_join2_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> ccompare<span class="main">,</span> unit<span class="main">)</span> mapping_rbt"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ID <span class="main">(</span>ccompare <span class="main">::</span> <span class="tfree">'a</span> comparator option<span class="main">)</span> <span class="main">≠</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"RBT_set <span class="free">t1</span> <span class="main">∪</span> RBT_set <span class="free">t2</span> <span class="main">=</span> RBT_set <span class="main">(</span>rbt_union_rbt_join2 <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> RBT_set_conv_keys<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> unit<span class="main">)</span> rbt"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> unit<span class="main">)</span> rbt"</span></span>
  <span class="keyword1"><span class="command">have</span></span> id_ccomp<span class="main">:</span> <span class="quoted"><span class="quoted">"ID ccompare <span class="main">=</span> Some <span class="main">(</span>ccomp <span class="main">::</span> <span class="tfree">'a</span> comparator<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"comparator <span class="main">(</span>ccomp <span class="main">::</span> <span class="tfree">'a</span> comparator<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ID_ccompare'<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"ord.is_rbt cless <span class="skolem">t1</span> <span class="main">∨</span> ID ccompare <span class="main">=</span> <span class="main">(</span>None <span class="main">::</span> <span class="tfree">'a</span> comparator option<span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"ord.is_rbt cless <span class="skolem">t2</span> <span class="main">∨</span> ID ccompare <span class="main">=</span> <span class="main">(</span>None <span class="main">::</span> <span class="tfree">'a</span> comparator option<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> rbt_sorted_t<span class="main">:</span> <span class="quoted"><span class="quoted">"ord.rbt_sorted cless <span class="skolem">t1</span>"</span></span> <span class="quoted"><span class="quoted">"ord.rbt_sorted cless <span class="skolem">t2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ord.is_rbt_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t1</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span>
    set <span class="main">(</span>RBT_Impl.keys <span class="main">(</span>rbt_recolor <span class="main">(</span>union_comp ccomp <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> linorder.rbt_sorted_union<span class="main">[</span><span class="operator">OF</span> ID_ccompare<span class="main"><span class="main">[</span></span><span class="operator">OF</span> id_ccomp<span class="main"><span class="main">]</span></span> rbt_sorted_t<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> union_comp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> c<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rbt_union_code<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t1</span> <span class="free">t2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> ccompare set_rbt"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"RBT_set <span class="free">t1</span> <span class="main">∪</span> RBT_set <span class="free">t2</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> ID <span class="keyword1">CCOMPARE</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> Code.abort <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''union RBT_set RBT_set: ccompare = None''</span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> RBT_set <span class="free">t1</span> <span class="main">∪</span> RBT_set <span class="free">t2</span><span class="main">)</span>
    <span class="main">|</span> Some <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> RBT_set <span class="main">(</span>rbt_union_rbt_join2 <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rbt_union_rbt_join2_set
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rbt_inter_rbt_join2_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> ccompare<span class="main">,</span> unit<span class="main">)</span> mapping_rbt"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ID <span class="main">(</span>ccompare <span class="main">::</span> <span class="tfree">'a</span> comparator option<span class="main">)</span> <span class="main">≠</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"RBT_set <span class="free">t1</span> <span class="main">∩</span> RBT_set <span class="free">t2</span> <span class="main">=</span> RBT_set <span class="main">(</span>rbt_inter_rbt_join2 <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> RBT_set_conv_keys<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> unit<span class="main">)</span> rbt"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> unit<span class="main">)</span> rbt"</span></span>
  <span class="keyword1"><span class="command">have</span></span> id_ccomp<span class="main">:</span> <span class="quoted"><span class="quoted">"ID ccompare <span class="main">=</span> Some <span class="main">(</span>ccomp <span class="main">::</span> <span class="tfree">'a</span> comparator<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"comparator <span class="main">(</span>ccomp <span class="main">::</span> <span class="tfree">'a</span> comparator<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ID_ccompare'<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"ord.is_rbt cless <span class="skolem">t1</span> <span class="main">∨</span> ID ccompare <span class="main">=</span> <span class="main">(</span>None <span class="main">::</span> <span class="tfree">'a</span> comparator option<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> rbt_sorted_t1<span class="main">:</span> <span class="quoted"><span class="quoted">"ord.rbt_sorted cless <span class="skolem">t1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ord.is_rbt_def<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"ord.is_rbt cless <span class="skolem">t2</span> <span class="main">∨</span> ID ccompare <span class="main">=</span> <span class="main">(</span>None <span class="main">::</span> <span class="tfree">'a</span> comparator option<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> rbt_sorted_t2<span class="main">:</span> <span class="quoted"><span class="quoted">"ord.rbt_sorted cless <span class="skolem">t2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ord.is_rbt_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t1</span><span class="main">)</span> <span class="main">∩</span> set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span>
    set <span class="main">(</span>RBT_Impl.keys <span class="main">(</span>rbt_recolor <span class="main">(</span>inter_comp ccomp <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> linorder.rbt_sorted_inter<span class="main">[</span><span class="operator">OF</span> ID_ccompare<span class="main"><span class="main">[</span></span><span class="operator">OF</span> id_ccomp<span class="main"><span class="main">]</span></span> rbt_sorted_t1 rbt_sorted_t2<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inter_comp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> c<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rbt_inter_code<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t1</span> <span class="free">t2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> ccompare set_rbt"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"RBT_set <span class="free">t1</span> <span class="main">∩</span> RBT_set <span class="free">t2</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> ID <span class="keyword1">CCOMPARE</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> Code.abort <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''inter RBT_set RBT_set: ccompare = None''</span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> RBT_set <span class="free">t1</span> <span class="main">∩</span> RBT_set <span class="free">t2</span><span class="main">)</span>
    <span class="main">|</span> Some <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> RBT_set <span class="main">(</span>rbt_inter_rbt_join2 <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rbt_inter_rbt_join2_set
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rbt_minus_rbt_join2_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> ccompare<span class="main">,</span> unit<span class="main">)</span> mapping_rbt"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ID <span class="main">(</span>ccompare <span class="main">::</span> <span class="tfree">'a</span> comparator option<span class="main">)</span> <span class="main">≠</span> None"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"RBT_set <span class="free">t1</span> <span class="main">-</span> RBT_set <span class="free">t2</span> <span class="main">=</span> RBT_set <span class="main">(</span>rbt_minus_rbt_join2 <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> RBT_set_conv_keys<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> unit<span class="main">)</span> rbt"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> unit<span class="main">)</span> rbt"</span></span>
  <span class="keyword1"><span class="command">have</span></span> id_ccomp<span class="main">:</span> <span class="quoted"><span class="quoted">"ID ccompare <span class="main">=</span> Some <span class="main">(</span>ccomp <span class="main">::</span> <span class="tfree">'a</span> comparator<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"comparator <span class="main">(</span>ccomp <span class="main">::</span> <span class="tfree">'a</span> comparator<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ID_ccompare'<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"ord.is_rbt cless <span class="skolem">t1</span> <span class="main">∨</span> ID ccompare <span class="main">=</span> <span class="main">(</span>None <span class="main">::</span> <span class="tfree">'a</span> comparator option<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> rbt_sorted_t1<span class="main">:</span> <span class="quoted"><span class="quoted">"rbt <span class="skolem">t1</span>"</span></span> <span class="quoted"><span class="quoted">"ord.rbt_sorted cless <span class="skolem">t1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ord.is_rbt_def rbt_def<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"ord.is_rbt cless <span class="skolem">t2</span> <span class="main">∨</span> ID ccompare <span class="main">=</span> <span class="main">(</span>None <span class="main">::</span> <span class="tfree">'a</span> comparator option<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> rbt_sorted_t2<span class="main">:</span> <span class="quoted"><span class="quoted">"ord.rbt_sorted cless <span class="skolem">t2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ord.is_rbt_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t1</span><span class="main">)</span> <span class="main">-</span> set <span class="main">(</span>RBT_Impl.keys <span class="skolem">t2</span><span class="main">)</span> <span class="main">=</span>
    set <span class="main">(</span>RBT_Impl.keys <span class="main">(</span>rbt_recolor <span class="main">(</span>minus_comp ccomp <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> linorder.rbt_sorted_minus<span class="main">[</span><span class="operator">OF</span> ID_ccompare<span class="main"><span class="main">[</span></span><span class="operator">OF</span> id_ccomp<span class="main"><span class="main">]</span></span> rbt_sorted_t1 rbt_sorted_t2<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> minus_comp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> c<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rbt_minus_code<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t1</span> <span class="free">t2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> ccompare set_rbt"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"RBT_set <span class="free">t1</span> <span class="main">-</span> RBT_set <span class="free">t2</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> ID <span class="keyword1">CCOMPARE</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> Code.abort <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''minus RBT_set RBT_set: ccompare = None''</span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> RBT_set <span class="free">t1</span> <span class="main">-</span> RBT_set <span class="free">t2</span><span class="main">)</span>
    <span class="main">|</span> Some <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> RBT_set <span class="main">(</span>rbt_minus_rbt_join2 <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rbt_minus_rbt_join2_set
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">typedef</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">overloaded</span></span><span class="main">)</span> <span class="tfree">'a</span> sdlist <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">xs</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> ccompare<span class="main">)</span> list<span class="main">.</span>
  <span class="keyword1">case</span> ID <span class="keyword1">CCOMPARE</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="bound">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">|</span> Some <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> linorder.sorted cless_eq <span class="bound">xs</span> <span class="main">∧</span> distinct <span class="bound">xs</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
     <span class="main">(</span><span class="operator">metis</span> keys_eq_Nil_iff sorted_RBT_Set_keys<span class="main">)</span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_sdlist

<span class="keyword1"><span class="command">lift_definition</span></span> sdlist_of_list <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> ccompare<span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'a</span> sdlist"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> <span class="keyword1">case</span> ID <span class="keyword1">CCOMPARE</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">[]</span> <span class="main">|</span> Some <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> remdups <span class="main">(</span>linorder.sort cless_eq <span class="bound">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> linorder.sorted_sort<span class="main">[</span><span class="operator">OF</span> ID_ccompare<span class="main">]</span> linorder.sorted_remdups<span class="main">[</span><span class="operator">OF</span> ID_ccompare<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_sdlist_of_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> ccompare<span class="main">)</span> list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> comparator"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"ID ccompare <span class="main">=</span> Some <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>Rep_sdlist <span class="main">(</span>sdlist_of_list <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> linorder.set_sort<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ID_ccompare<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sset_rbt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> ccompare<span class="main">)</span> list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> comparator"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"ID ccompare <span class="main">=</span> Some <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"linorder.sorted cless_eq <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ord.is_rbt cless <span class="main">(</span>rbtreeify <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms linorder.is_rbt_rbtreeify<span class="main">[</span><span class="operator">OF</span> ID_ccompare<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> comp_def<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> sset <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> ccompare<span class="main">)</span> sdlist <span class="main">⇒</span> <span class="tfree">'a</span> set_rbt"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> rbtreeify <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">)</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sset_rbt
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> Rep_sdlist_keys<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> ccompare<span class="main">)</span> sdlist"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Rep_sdlist <span class="free">xs</span> <span class="main">=</span> RBT_Set2.keys <span class="main">(</span>sset <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> RBT_Impl.keys_def comp_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rbt_comp_lookup_iff_in_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> ccompare"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> comparator"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ID ccompare <span class="main">=</span> Some <span class="free">c</span>"</span></span> <span class="quoted"><span class="quoted">"linorder.sorted cless_eq <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rbt_comp_lookup ccomp <span class="main">(</span>rbtreeify <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> Some <span class="main">()</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> linorder.rbt_lookup_rbtreeify<span class="main">[</span><span class="operator">OF</span> ID_ccompare<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span>"</span></span><span class="main">]</span>
      assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rbt_comp_lookup<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ID_ccompare'<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> map_of_map_Pair_const
      comp_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> RBT_set_sset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> ccompare<span class="main">)</span> sdlist"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"RBT_set <span class="main">(</span>sset <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>Rep_sdlist <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> RBT_set_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">transfer</span>
  <span class="keyword1"><span class="command">using</span></span> rbt_comp_lookup_iff_in_set
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rbtreeify_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_code<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> ccompare<span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> ID <span class="keyword1">CCOMPARE</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> Code.abort <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''set: ccompare = None''</span><span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> set <span class="free">xs</span><span class="main">)</span>
  <span class="main">|</span> Some <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> RBT_set <span class="main">(</span>sset <span class="main">(</span>sdlist_of_list <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> RBT_set_sset set_sdlist_of_list <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> linorder_sorted_upt<span class="main">:</span> <span class="quoted"><span class="quoted">"linorder.sorted <span class="main">(</span>le_of_comp compare<span class="main">)</span> <span class="main">[</span><span class="free">n</span><span class="main">..&lt;</span><span class="free">n'</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat comparator"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> compare"</span></span>
  <span class="keyword1"><span class="command">have</span></span> cl<span class="main">:</span> <span class="quoted"><span class="quoted">"class.linorder <span class="main">(</span>le_of_comp <span class="skolem">c</span><span class="main">)</span> <span class="main">(</span>lt_of_comp <span class="skolem">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> c_def ID_ccompare ID_Some ccompare_nat_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> linorder.sorted_sorted_wrt<span class="main">[</span><span class="operator">OF</span> cl<span class="main">]</span> sorted_wrt_mono_rel<span class="main">[</span><span class="operator">OF</span> _ sorted_wrt_upt<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> c_def ord_defs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> upt_sdlist <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat sdlist"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">upt</span>
  <span class="keyword1"><span class="command">using</span></span> linorder_sorted_upt
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ID_Some ccompare_nat_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">nat_set_upt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nat_set_upt</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nat_set_upt_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"nat_set_upt <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> RBT_set <span class="main">(</span>sset <span class="main">(</span>upt_sdlist <span class="free">i</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nat_set_upt_def RBT_set_sset upt_sdlist.rep_eq<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> Set_union_code<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> rbt_union_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> Set_inter_code<span class="main">(</span>16<span class="main">)</span><span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> rbt_inter_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="comment1">(* Set_minus on RBTs not supported in Set_Impl! *)</span>
<span class="keyword1"><span class="command">declare</span></span> Set_minus_code<span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> rbt_minus_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="comment1">(*
The following code equation requires an executable sorting algorithm for ccompare.
declare Set_Impl.set_code[code del]
declare set_code[code]
*)</span>

<span class="keyword1"><span class="command">declare</span></span> nat_set_upt_prop<span class="main">[</span><span class="operator">code</span><span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</body>

</html>