<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory Generic_Join</title>
</head>


<body>
<div class="head">
<h1>Theory Generic_Join</h1>
</div>

<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The algorithm›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Generic_Join
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../MFOTL_Monitor_Devel/Table.html">MFOTL_Monitor_Devel.Table</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> atable <span class="main">=</span> <span class="quoted"><span class="quoted">"nat set <span class="main">×</span> <span class="tfree">'a</span> table"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> query <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> atable set"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> vertices <span class="main">=</span> <span class="quoted"><span class="quoted">"nat set"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> satable <span class="main">=</span> <span class="quoted"><span class="quoted">"nat set <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> tuple <span class="main">⇒</span> <span class="tfree">'a</span> tuple set<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> squery <span class="main">=</span> <span class="quoted"><span class="quoted">"nat set <span class="main">×</span> nat set <span class="main">×</span> <span class="tfree">'a</span> satable set"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Generic algorithm›</span></span>

<span class="keyword1"><span class="command">locale</span></span> getIJ <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">getIJ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> query <span class="main">⇒</span> <span class="tfree">'a</span> query <span class="main">⇒</span> vertices <span class="main">⇒</span> vertices <span class="main">×</span> vertices"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> coreProperties<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="free">V</span> <span class="main">≥</span> <span class="numeral">2</span> <span class="main">⟹</span> <span class="free">getIJ</span> <span class="free">Q_pos</span> <span class="free">Q_neg</span> <span class="free">V</span> <span class="main">=</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">J</span><span class="main">)</span> <span class="main">⟹</span>
    card <span class="free">I</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">∧</span> card <span class="free">J</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">∧</span> <span class="free">V</span> <span class="main">=</span> <span class="free">I</span> <span class="main">∪</span> <span class="free">J</span> <span class="main">∧</span> <span class="free">I</span> <span class="main">∩</span> <span class="free">J</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> getIJProperties<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">V</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">J</span><span class="main">)</span> <span class="main">=</span> <span class="free">getIJ</span> <span class="free">Q_pos</span> <span class="free">Q_neg</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="free">I</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="free">J</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="free">I</span> <span class="main">&lt;</span> card <span class="free">V</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="free">J</span> <span class="main">&lt;</span> card <span class="free">V</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">=</span> <span class="free">I</span> <span class="main">∪</span> <span class="free">J</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">∩</span> <span class="free">J</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> card <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> coreProperties<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">Q_pos</span></span> <span class="quoted"><span class="free">Q_neg</span></span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">J</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> card <span class="free">J</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> coreProperties<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">Q_pos</span></span> <span class="quoted"><span class="free">Q_neg</span></span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">J</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="free">I</span> <span class="main">&lt;</span> card <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Int_ac<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> One_nat_def Suc_le_lessD assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
        assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> card_gt_0_iff card_seteq dual_order.trans getIJ.coreProperties getIJ_axioms leI
        le_iff_inf one_le_numeral sup_ge1 sup_ge2<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="free">J</span> <span class="main">&lt;</span> card <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_1 assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> card_gt_0_iff card_seteq
        getIJ.coreProperties getIJ_axioms leI le_0_eq le_iff_inf nat.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> sup_ge1 sup_ge2<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">=</span> <span class="free">I</span> <span class="main">∪</span> <span class="free">J</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> getIJ.coreProperties getIJ_axioms<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">∩</span> <span class="free">J</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> getIJ_axioms getIJ_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">projectTable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vertices <span class="main">⇒</span> <span class="tfree">'a</span> atable <span class="main">⇒</span> <span class="tfree">'a</span> atable"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">projectTable</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span> Set.image <span class="main">(</span>restrict <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">filterQuery</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vertices <span class="main">⇒</span> <span class="tfree">'a</span> query <span class="main">⇒</span> <span class="tfree">'a</span> query"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">filterQuery</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">=</span> Set.filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> Set.is_empty <span class="main">(</span><span class="bound">s</span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">filterQueryNeg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vertices <span class="main">⇒</span> <span class="tfree">'a</span> query <span class="main">⇒</span> <span class="tfree">'a</span> query"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">filterQueryNeg</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">=</span> Set.filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="bound">A</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">projectQuery</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vertices <span class="main">⇒</span> <span class="tfree">'a</span> query <span class="main">⇒</span> <span class="tfree">'a</span> query"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">projectQuery</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> Set.image <span class="main">(</span>projectTable <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">isSameIntersection</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tuple <span class="main">⇒</span> nat set <span class="main">⇒</span> <span class="tfree">'a</span> tuple <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">isSameIntersection</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> <span class="main">(</span>restrict <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> restrict <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">semiJoin</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> atable <span class="main">⇒</span> <span class="main">(</span>nat set <span class="main">×</span> <span class="tfree">'a</span> tuple<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> atable"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">semiJoin</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tab</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tup</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> Set.filter <span class="main">(</span>isSameIntersection <span class="free"><span class="bound"><span class="entity">tup</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tab</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">newQuery</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vertices <span class="main">⇒</span> <span class="tfree">'a</span> query <span class="main">⇒</span> <span class="main">(</span>nat set <span class="main">×</span> <span class="tfree">'a</span> tuple<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> query"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">newQuery</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> Set.image <span class="main">(</span><span class="main">λ</span><span class="bound">tab</span><span class="main">.</span> projectTable <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">(</span>semiJoin <span class="bound">tab</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">merge_option</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> option <span class="main">×</span> <span class="tfree">'a</span> option <span class="main">⇒</span> <span class="tfree">'a</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_option</span> <span class="main">(</span>None<span class="main">,</span> None<span class="main">)</span> <span class="main">=</span> None"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge_option</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> None<span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge_option</span> <span class="main">(</span>None<span class="main">,</span> Some <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge_option</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> Some <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="comment1">(* Last case shouldn't happen but useful for proof *)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">merge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tuple <span class="main">⇒</span> <span class="tfree">'a</span> tuple <span class="main">⇒</span> <span class="tfree">'a</span> tuple"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> map merge_option <span class="main">(</span>zip <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">)</span> <span class="entity">genericJoin</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vertices <span class="main">⇒</span> <span class="tfree">'a</span> query <span class="main">⇒</span> <span class="tfree">'a</span> query <span class="main">⇒</span> <span class="tfree">'a</span> table"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">genericJoin</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">Q_pos</span></span></span> <span class="free"><span class="bound"><span class="entity">Q_neg</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> card <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">≤</span> <span class="main">1</span> <span class="keyword1">then</span>
      <span class="main">(</span><span class="main">⋂</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">Q_pos</span></span></span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">Q_neg</span></span></span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>
    <span class="keyword1">else</span>
      <span class="keyword1">let</span> <span class="main">(</span><span class="bound">I</span><span class="main">,</span> <span class="bound">J</span><span class="main">)</span> <span class="main">=</span> <span class="free">getIJ</span> <span class="free"><span class="bound"><span class="entity">Q_pos</span></span></span> <span class="free"><span class="bound"><span class="entity">Q_neg</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">Q_I_pos</span> <span class="main">=</span> projectQuery <span class="bound">I</span> <span class="main">(</span>filterQuery <span class="bound">I</span> <span class="free"><span class="bound"><span class="entity">Q_pos</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">Q_I_neg</span> <span class="main">=</span> filterQueryNeg <span class="bound">I</span> <span class="free"><span class="bound"><span class="entity">Q_neg</span></span></span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">R_I</span> <span class="main">=</span> <span class="free">genericJoin</span> <span class="bound">I</span> <span class="bound">Q_I_pos</span> <span class="bound">Q_I_neg</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">Q_J_neg</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Q_neg</span></span></span> <span class="main">-</span> <span class="bound">Q_I_neg</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">Q_J_pos</span> <span class="main">=</span> filterQuery <span class="bound">J</span> <span class="free"><span class="bound"><span class="entity">Q_pos</span></span></span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">X</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="free">genericJoin</span> <span class="bound">J</span> <span class="main">(</span>newQuery <span class="bound">J</span> <span class="bound">Q_J_pos</span> <span class="main">(</span><span class="bound">I</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>newQuery <span class="bound">J</span> <span class="bound">Q_J_neg</span> <span class="main">(</span><span class="bound">I</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
        <span class="main">|</span> <span class="bound">t</span> <span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="bound">R_I</span><span class="main">}</span> <span class="keyword1">in</span>
      <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">.</span> <span class="main">{</span>merge <span class="bound">xx</span> <span class="bound">t</span> <span class="main">|</span> <span class="bound">xx</span> <span class="main">.</span> <span class="bound">xx</span> <span class="main">∈</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">V</span><span class="main">,</span> <span class="bound">Q_pos</span><span class="main">,</span> <span class="bound">Q_neg</span><span class="main">)</span><span class="main">.</span> card <span class="bound">V</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> getIJProperties<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">squery_of_query</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vertices <span class="main">⇒</span> vertices <span class="main">⇒</span> <span class="tfree">'a</span> query <span class="main">⇒</span> <span class="tfree">'a</span> squery"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">squery_of_query</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">J</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">J</span></span></span><span class="main">,</span> Set.image <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">V</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span><span class="main">.</span>
    <span class="main">(</span><span class="bound">V</span><span class="main">,</span> Equiv_Relations.proj <span class="main">(</span>Set.image <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span>restrict <span class="main">(</span><span class="bound">V</span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="bound">t</span><span class="main">,</span> restrict <span class="free"><span class="bound"><span class="entity">J</span></span></span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="bound">T</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">query_of_squery</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> squery <span class="main">⇒</span> <span class="tfree">'a</span> tuple <span class="main">⇒</span> <span class="tfree">'a</span> query"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">query_of_squery</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">J</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">SQ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> Set.image <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">V</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">V</span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">J</span></span></span><span class="main">,</span> <span class="bound">f</span> <span class="main">(</span>restrict <span class="main">(</span><span class="bound">V</span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">SQ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> squery_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟹</span> newQuery <span class="free">J</span> <span class="free">Q</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> query_of_squery <span class="main">(</span>squery_of_query <span class="free">I</span> <span class="free">J</span>
  <span class="main">(</span>Set.image <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">V</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">let</span> <span class="bound">R'</span> <span class="main">=</span> restrict <span class="main">(</span><span class="bound">V</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span> <span class="main">`</span> <span class="free">R</span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="bound">V</span><span class="main">,</span> Set.filter <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> restrict <span class="main">(</span><span class="bound">V</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span> <span class="bound">t</span> <span class="main">∈</span> <span class="bound">R'</span><span class="main">)</span> <span class="bound">T</span><span class="main">)</span><span class="main">)</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Equiv_Relations.proj_def image_image <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> image_cong rev_image_eqI<span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> genericJoin_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"genericJoin <span class="free">V</span> <span class="free">Q_pos</span> <span class="free">Q_neg</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> card <span class="free">V</span> <span class="main">≤</span> <span class="main">1</span> <span class="keyword1">then</span>
      <span class="main">(</span><span class="main">⋂</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_pos</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_neg</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>
    <span class="keyword1">else</span>
      <span class="keyword1">let</span> <span class="main">(</span><span class="bound">I</span><span class="main">,</span> <span class="bound">J</span><span class="main">)</span> <span class="main">=</span> <span class="free">getIJ</span> <span class="free">Q_pos</span> <span class="free">Q_neg</span> <span class="free">V</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">Q_I_pos</span> <span class="main">=</span> projectQuery <span class="bound">I</span> <span class="main">(</span>filterQuery <span class="bound">I</span> <span class="free">Q_pos</span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">Q_I_neg</span> <span class="main">=</span> filterQueryNeg <span class="bound">I</span> <span class="free">Q_neg</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">R_I</span> <span class="main">=</span> genericJoin <span class="bound">I</span> <span class="bound">Q_I_pos</span> <span class="bound">Q_I_neg</span> <span class="keyword1">in</span>
      <span class="main">(</span><span class="keyword1">if</span> Set.is_empty <span class="bound">R_I</span> <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span>
        <span class="keyword1">let</span> <span class="bound">Q_J_neg</span> <span class="main">=</span> <span class="free">Q_neg</span> <span class="main">-</span> <span class="bound">Q_I_neg</span> <span class="keyword1">in</span>
        <span class="keyword1">let</span> <span class="bound">Q_J_pos</span> <span class="main">=</span> filterQuery <span class="bound">J</span> <span class="free">Q_pos</span> <span class="keyword1">in</span>
        <span class="keyword1">let</span> <span class="bound">SQ_J_pos</span> <span class="main">=</span> squery_of_query <span class="bound">I</span> <span class="bound">J</span> <span class="main">(</span>Set.image <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">V</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span><span class="main">.</span>
          <span class="keyword1">let</span> <span class="bound">V'</span> <span class="main">=</span> <span class="bound">V</span> <span class="main">∩</span> <span class="bound">I</span><span class="main">;</span> <span class="bound">R'</span> <span class="main">=</span> restrict <span class="bound">V'</span> <span class="main">`</span> <span class="bound">R_I</span> <span class="keyword1">in</span>
          <span class="main">(</span><span class="bound">V</span><span class="main">,</span> Set.filter <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> restrict <span class="bound">V'</span> <span class="bound">t</span> <span class="main">∈</span> <span class="bound">R'</span><span class="main">)</span> <span class="bound">T</span><span class="main">)</span><span class="main">)</span> <span class="bound">Q_J_pos</span><span class="main">)</span> <span class="keyword1">in</span>
        <span class="keyword1">let</span> <span class="bound">SQ_J_neg</span> <span class="main">=</span> squery_of_query <span class="bound">I</span> <span class="bound">J</span> <span class="main">(</span>Set.image <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">V</span><span class="main">,</span> <span class="bound">T</span><span class="main">)</span><span class="main">.</span>
          <span class="keyword1">let</span> <span class="bound">V'</span> <span class="main">=</span> <span class="bound">V</span> <span class="main">∩</span> <span class="bound">I</span><span class="main">;</span> <span class="bound">R'</span> <span class="main">=</span> restrict <span class="bound">V'</span> <span class="main">`</span> <span class="bound">R_I</span> <span class="keyword1">in</span>
          <span class="main">(</span><span class="bound">V</span><span class="main">,</span> Set.filter <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> restrict <span class="bound">V'</span> <span class="bound">t</span> <span class="main">∈</span> <span class="bound">R'</span><span class="main">)</span> <span class="bound">T</span><span class="main">)</span><span class="main">)</span> <span class="bound">Q_J_neg</span><span class="main">)</span> <span class="keyword1">in</span>
        <span class="keyword1">let</span> <span class="bound">X</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> genericJoin <span class="bound">J</span> <span class="main">(</span>query_of_squery <span class="bound">SQ_J_pos</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>query_of_squery <span class="bound">SQ_J_neg</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>
          <span class="main">|</span> <span class="bound">t</span> <span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="bound">R_I</span><span class="main">}</span> <span class="keyword1">in</span>
        <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">.</span> <span class="main">{</span>merge <span class="bound">xx</span> <span class="bound">t</span> <span class="main">|</span> <span class="bound">xx</span> <span class="main">.</span> <span class="bound">xx</span> <span class="main">∈</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> genericJoin.simps<span class="main">)</span>
     <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Let_def Set.is_empty_def squery_correct <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">wrapperGenericJoin</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> query <span class="main">⇒</span> <span class="tfree">'a</span> query <span class="main">⇒</span> <span class="tfree">'a</span> table"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wrapperGenericJoin</span> <span class="free"><span class="bound"><span class="entity">Q_pos</span></span></span> <span class="free"><span class="bound"><span class="entity">Q_neg</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">Q_pos</span></span></span><span class="main">.</span> Set.is_empty <span class="bound">X</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">Q_neg</span></span></span><span class="main">.</span> Set.is_empty <span class="bound">A</span> <span class="main">∧</span> <span class="main">¬</span> Set.is_empty <span class="bound">X</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span>
      <span class="main">{}</span>
    <span class="keyword1">else</span>
      <span class="keyword1">let</span> <span class="bound">Q</span> <span class="main">=</span> Set.filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> Set.is_empty <span class="bound">A</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q_pos</span></span></span> <span class="keyword1">in</span>
      <span class="keyword1">if</span> Set.is_empty <span class="bound">Q</span> <span class="keyword1">then</span>
        <span class="main">(</span><span class="main">⋂</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">Q_pos</span></span></span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span> <span class="main">-</span>  <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">Q_neg</span></span></span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span>
      <span class="keyword1">else</span>
        <span class="keyword1">let</span> <span class="bound">V</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="bound">Q</span><span class="main">.</span> <span class="bound">A</span><span class="main">)</span> <span class="keyword1">in</span>
        <span class="keyword1">let</span> <span class="bound">Qn</span> <span class="main">=</span> Set.filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="bound">A</span> <span class="main">⊆</span> <span class="bound">V</span> <span class="main">∧</span> card <span class="bound">A</span> <span class="main">≥</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q_neg</span></span></span> <span class="keyword1">in</span>
        genericJoin <span class="bound">V</span> <span class="bound">Q</span> <span class="bound">Qn</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹An instantation›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">score</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> query <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">score</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> sum <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> card <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>Set.filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">sign</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∈</span> <span class="bound">sign</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">arg_max_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">::</span>linorder<span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">arg_max_list</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">arg_max_list</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">zs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">m</span> <span class="main">=</span> <span class="free">arg_max_list</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">zs</span></span></span><span class="main">)</span> <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">m</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">else</span> <span class="bound">m</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> arg_max_list_element<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">l</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"arg_max_list <span class="free">f</span> <span class="free">l</span> <span class="main">∈</span> set <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> induct_list012<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">max_getIJ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> query <span class="main">⇒</span> <span class="tfree">'a</span> query <span class="main">⇒</span> vertices <span class="main">⇒</span> vertices <span class="main">×</span> vertices"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">max_getIJ</span> <span class="free"><span class="bound"><span class="entity">Q_pos</span></span></span> <span class="free"><span class="bound"><span class="entity">Q_neg</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">let</span> <span class="bound">l</span> <span class="main">=</span> sorted_list_of_set <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="keyword1">in</span>
  <span class="keyword1">if</span> Set.is_empty <span class="free"><span class="bound"><span class="entity">Q_neg</span></span></span> <span class="keyword1">then</span>
    <span class="keyword1">let</span> <span class="bound">x</span> <span class="main">=</span> arg_max_list <span class="main">(</span>score <span class="free"><span class="bound"><span class="entity">Q_pos</span></span></span><span class="main">)</span> <span class="bound">l</span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span>
  <span class="keyword1">else</span>
    <span class="keyword1">let</span> <span class="bound">x</span> <span class="main">=</span> arg_max_list <span class="main">(</span>score <span class="free"><span class="bound"><span class="entity">Q_neg</span></span></span><span class="main">)</span> <span class="bound">l</span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> max_getIJ_coreProperties<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">V</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">J</span><span class="main">)</span> <span class="main">=</span> max_getIJ <span class="free">Q_pos</span> <span class="free">Q_neg</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="free">I</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">∧</span> card <span class="free">J</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">∧</span> <span class="free">V</span> <span class="main">=</span> <span class="free">I</span> <span class="main">∪</span> <span class="free">J</span> <span class="main">∧</span> <span class="free">I</span> <span class="main">∩</span> <span class="free">J</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> card.infinite <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> sorted_list_of_set <span class="free">V</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">l</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_1 Suc_le_lessD <span class="quoted"><span class="quoted">‹finite <span class="free">V</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> distinct_card
        distinct_sorted_list_of_set less_imp_le set_sorted_list_of_set<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Set.is_empty <span class="free">Q_neg</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> arg_max_list <span class="main">(</span>score <span class="free">Q_pos</span><span class="main">)</span> <span class="skolem">l</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span>set <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">≤</span> length <span class="skolem">l</span>›</span></span> arg_max_list_element <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">V</span>›</span></span> l_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">J</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">,</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">J</span><span class="main">)</span> <span class="main">=</span>  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">l</span> <span class="main">=</span> sorted_list_of_set <span class="free">V</span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="bound">x</span> <span class="main">=</span> arg_max_list <span class="main">(</span>score <span class="free">Q_pos</span><span class="main">)</span> <span class="bound">l</span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">,</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> True assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> l_def x_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Pair_inject <span class="quoted"><span class="quoted">‹finite <span class="free">V</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> arg_max_list <span class="main">(</span>score <span class="free">Q_neg</span><span class="main">)</span> <span class="skolem">l</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span>set <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">≤</span> length <span class="skolem">l</span>›</span></span> arg_max_list_element <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">V</span>›</span></span> l_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">J</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">J</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">l</span> <span class="main">=</span> sorted_list_of_set <span class="free">V</span> <span class="keyword1">in</span>
  <span class="keyword1">let</span> <span class="bound">x</span> <span class="main">=</span> arg_max_list <span class="main">(</span>score <span class="free">Q_neg</span><span class="main">)</span> <span class="bound">l</span> <span class="keyword1">in</span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> False assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> l_def x_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Pair_inject <span class="quoted"><span class="quoted">‹finite <span class="free">V</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> New_max<span class="main">:</span> getIJ <span class="quoted">max_getIJ</span>
  <span class="keyword2"><span class="keyword">defines</span></span> New_max_getIJ_genericJoin <span class="main">=</span> <span class="quoted"><span class="quoted">"New_max.genericJoin"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> New_max_getIJ_wrapperGenericJoin <span class="main">=</span> <span class="quoted"><span class="quoted">"New_max.wrapperGenericJoin"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">metis</span> max_getIJ_coreProperties<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</body>

</html>