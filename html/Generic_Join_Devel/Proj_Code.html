<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory Proj_Code</title>
</head>


<body>
<div class="head">
<h1>Theory Proj_Code</h1>
</div>

<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Proj_Code
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../Containers/Containers.html">Containers.Containers</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">images</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span> set<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">images</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> fst <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> images_iff_proj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> images <span class="free">X</span> <span class="main">⟷</span> <span class="free">B</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∧</span> Equiv_Relations.proj <span class="free">X</span> <span class="free">a</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Equiv_Relations.proj_def images_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> proj_empty_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"Equiv_Relations.proj <span class="free">X</span> <span class="free">a</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">∉</span> fst <span class="main">`</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> image_iff
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Equiv_Relations.proj_def Image_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> proj_iff_images<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> Equiv_Relations.proj <span class="free">X</span> <span class="free">a</span> <span class="main">=</span> <span class="free">B</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> images <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> images_iff_proj<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> proj_iff_images'<span class="main">:</span> <span class="quoted"><span class="quoted">"Equiv_Relations.proj <span class="free">X</span> <span class="free">a</span> <span class="main">=</span> <span class="free">B</span> <span class="main">⟷</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free">B</span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> <span class="free">a</span> <span class="main">∉</span> fst <span class="main">`</span> <span class="free">X</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">B</span><span class="main">)</span> <span class="main">∈</span> images <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_empty_iff proj_iff_images<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fst_imagesI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">∈</span> fst <span class="main">`</span> images <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> images_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> fstI image_iff<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">flatten</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span> set<span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">flatten</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> <span class="main">⋃</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">B</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="bound">B</span><span class="main">)</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> flatten_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"flatten <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> flatten_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> images_flatten<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∉</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">B</span> <span class="bound">B'</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">B</span><span class="main">)</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">B'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="bound">B</span> <span class="main">=</span> <span class="bound">B'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"images <span class="main">(</span>flatten <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">aB</span>
  <span class="keyword3"><span class="command">assume</span></span> aB_X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">aB</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> aB_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">aB</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> aB_X
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> aB_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> b_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> flatten <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> aB_X
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> aB_def flatten_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">aB</span> <span class="main">∈</span> images <span class="main">(</span>flatten <span class="free">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> b_def assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> aB_X<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> aB_def<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> aB_def images_iff_proj Equiv_Relations.proj_def flatten_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">aB</span>
  <span class="keyword3"><span class="command">assume</span></span> aB_X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">aB</span> <span class="main">∈</span> images <span class="main">(</span>flatten <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> aB_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">aB</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B'</span></span> <span class="keyword2"><span class="keyword">where</span></span> B'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">B'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> flatten <span class="free">X</span> <span class="main">⟷</span> <span class="bound">b</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> aB_X
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> flatten_def aB_def images_iff_proj Equiv_Relations.proj_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="skolem">B'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> flatten <span class="free">X</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> B'_def<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B''</span></span> <span class="keyword2"><span class="keyword">where</span></span> B''_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">B''</span><span class="main">)</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="skolem">B''</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> flatten_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="skolem">B'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> B'_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> B''_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> B''_def<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="main">∈</span> <span class="skolem">B'</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="main">∈</span> <span class="skolem">B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> B'_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> flatten_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">aB</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B'_def<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> aB_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> ord
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">add_to_rbt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span> set<span class="main">)</span> rbt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span> set<span class="main">)</span> rbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">add_to_rbt</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="keyword1">case</span> rbt_lookup <span class="bound">t</span> <span class="bound">a</span> <span class="keyword1">of</span> None <span class="main">⇒</span> rbt_insert <span class="bound">a</span> <span class="main">{</span><span class="bound">b</span><span class="main">}</span> <span class="bound">t</span>
  <span class="main">|</span> Some <span class="bound">X</span> <span class="main">⇒</span> rbt_insert <span class="bound">a</span> <span class="main">(</span><span class="bound">X</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">b</span><span class="main">}</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rbt_set_to_rbt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">,</span> unit<span class="main">)</span> rbt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span> set<span class="main">)</span> rbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rbt_set_to_rbt</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> RBT_Impl.fold <span class="main">(</span><span class="main">λ</span><span class="bound">ab</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> add_to_rbt <span class="bound">ab</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> RBT_Impl.Empty"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> linorder
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> is_rbt_add_to_rbt<span class="main">:</span> <span class="quoted"><span class="quoted">"is_rbt <span class="free">t</span> <span class="main">⟹</span> is_rbt <span class="main">(</span>add_to_rbt <span class="free">ab</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_to_rbt_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_rbt_fold_add_to_rbt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_rbt <span class="free">t'</span> <span class="main">⟹</span> is_rbt <span class="main">(</span>RBT_Impl.fold <span class="main">(</span><span class="main">λ</span><span class="bound">ab</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> add_to_rbt <span class="bound">ab</span><span class="main">)</span> <span class="free">t</span> <span class="free">t'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t'</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 0 0 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_rbt_add_to_rbt<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> is_rbt_rbt_set_to_rbt<span class="main">:</span> <span class="quoted"><span class="quoted">"is_rbt <span class="main">(</span>rbt_set_to_rbt <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> is_rbt_fold_add_to_rbt Empty_is_rbt
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rbt_set_to_rbt_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rbt_insert_entries_None<span class="main">:</span> <span class="quoted"><span class="quoted">"is_rbt <span class="free">t</span> <span class="main">⟹</span> rbt_lookup <span class="free">t</span> <span class="free">k</span> <span class="main">=</span> None <span class="main">⟹</span>
  set <span class="main">(</span>RBT_Impl.entries <span class="main">(</span>rbt_insert <span class="free">k</span> <span class="free">v</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>RBT_Impl.entries <span class="free">t</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rbt_lookup_in_tree<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> rbt_lookup_rbt_insert <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rbt_insert_entries_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"is_rbt <span class="free">t</span> <span class="main">⟹</span> rbt_lookup <span class="free">t</span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">v'</span> <span class="main">⟹</span>
  set <span class="main">(</span>RBT_Impl.entries <span class="main">(</span>rbt_insert <span class="free">k</span> <span class="free">v</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>RBT_Impl.entries <span class="free">t</span><span class="main">)</span> <span class="main">-</span> <span class="main">{</span><span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v'</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rbt_lookup_in_tree<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> rbt_lookup_rbt_insert <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> flatten_add_to_rbt<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_rbt <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"flatten <span class="main">(</span>set <span class="main">(</span>RBT_Impl.entries <span class="main">(</span>add_to_rbt <span class="free">ab</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">{</span><span class="free">ab</span><span class="main">}</span> <span class="main">∪</span> flatten <span class="main">(</span>set <span class="main">(</span>RBT_Impl.entries <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> ab_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ab</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"rbt_lookup <span class="free">t</span> <span class="skolem">a</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_to_rbt_def ab_def None flatten_def rbt_insert_entries_None<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms None<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">B</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_to_rbt_def ab_def Some flatten_def rbt_insert_entries_Some<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms Some<span class="main"><span class="main">]</span></span>
          <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
         <span class="main">(</span><span class="operator">meson</span> assms Some image_iff is_rbt_rbt_sorted rbt_lookup_in_tree<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nonempty_add_to_rbt<span class="main">:</span> <span class="quoted"><span class="quoted">"is_rbt <span class="free">t</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span>RBT_Impl.entries <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span>RBT_Impl.entries <span class="main">(</span>add_to_rbt <span class="free">ab</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_to_rbt_def rbt_insert_entries_None <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits option.splits<span class="main">)</span>
     <span class="main">(</span><span class="operator">smt</span> insert_not_empty is_rbt_rbt_sorted rbt_insert_rbt_sorted rbt_lookup_in_tree
      rbt_lookup_rbt_insert map_upd_Some_unfold<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> flatten_fold_add_to_rbt<span class="main">:</span> <span class="quoted"><span class="quoted">"is_rbt <span class="free">t'</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span>RBT_Impl.entries <span class="free">t'</span><span class="main">)</span> <span class="main">⟹</span>
  flatten <span class="main">(</span>set <span class="main">(</span>RBT_Impl.entries <span class="main">(</span>RBT_Impl.fold <span class="main">(</span><span class="main">λ</span><span class="bound">ab</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> add_to_rbt <span class="bound">ab</span><span class="main">)</span> <span class="free">t</span> <span class="free">t'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  set <span class="main">(</span>RBT_Impl.keys <span class="free">t</span><span class="main">)</span> <span class="main">∪</span> flatten <span class="main">(</span>set <span class="main">(</span>RBT_Impl.entries <span class="free">t'</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span>RBT_Impl.entries <span class="main">(</span>RBT_Impl.fold <span class="main">(</span><span class="main">λ</span><span class="bound">ab</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> add_to_rbt <span class="bound">ab</span><span class="main">)</span> <span class="free">t</span> <span class="free">t'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">t'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Branch <span class="skolem">c</span> <span class="skolem">t1</span> <span class="skolem">ab</span> <span class="skolem">v</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Branch<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> Branch<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">,</span></span></span>4<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span>
        flatten_add_to_rbt<span class="main"><span class="main">[</span></span><span class="operator">OF</span> is_rbt_fold_add_to_rbt<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> Branch<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span>
        Branch<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> is_rbt_add_to_rbt<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> is_rbt_fold_add_to_rbt<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> Branch<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">,</span></span>
        <span class="operator">OF</span> nonempty_add_to_rbt<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> is_rbt_fold_add_to_rbt<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> Branch<span class="main"><span class="main"><span class="main">(</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="skolem">t1</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> flatten_rbt_set_to_mapping<span class="main">:</span> <span class="quoted"><span class="quoted">"flatten <span class="main">(</span>set <span class="main">(</span>RBT_Impl.entries <span class="main">(</span>rbt_set_to_rbt <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
  set <span class="main">(</span>RBT_Impl.keys <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rbt_set_to_rbt_def flatten_fold_add_to_rbt<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nonempty_rbt_set_to_mapping<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∉</span> set <span class="main">(</span>RBT_Impl.entries <span class="main">(</span>rbt_set_to_rbt <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rbt_set_to_rbt_def flatten_fold_add_to_rbt<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> images_rbt_set_to_mapping<span class="main">:</span>
  <span class="quoted"><span class="quoted">"images <span class="main">(</span>set <span class="main">(</span>RBT_Impl.keys <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>RBT_Impl.entries <span class="main">(</span>rbt_set_to_rbt <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"images <span class="main">(</span>flatten <span class="main">(</span>set <span class="main">(</span>RBT_Impl.entries <span class="main">(</span>rbt_set_to_rbt <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    set <span class="main">(</span>RBT_Impl.entries <span class="main">(</span>rbt_set_to_rbt <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> images_flatten<span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_rbt_rbt_set_to_rbt rbt_sorted_entries_right_unique
        nonempty_rbt_set_to_mapping<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> flatten_rbt_set_to_mapping<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> proj_rbt_set_to_mapping<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Equiv_Relations.proj <span class="main">(</span>set <span class="main">(</span>RBT_Impl.keys <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> map_of <span class="main">(</span>RBT_Impl.entries <span class="main">(</span>rbt_set_to_rbt <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">a</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">{}</span> <span class="main">|</span> Some <span class="bound">X</span> <span class="main">⇒</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> proj_iff_images' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> images_rbt_set_to_mapping<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> images_iff_proj
      map_of_eq_None_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> map_of_SomeD <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fst_imagesI<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> comparator"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">add_to_rbt_comp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span> set<span class="main">)</span> rbt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span> set<span class="main">)</span> rbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">add_to_rbt_comp</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="bound">t</span><span class="main">.</span> <span class="keyword1">case</span> rbt_comp_lookup <span class="free">c</span> <span class="bound">t</span> <span class="bound">a</span> <span class="keyword1">of</span> None <span class="main">⇒</span> rbt_comp_insert <span class="free">c</span> <span class="bound">a</span> <span class="main">{</span><span class="bound">b</span><span class="main">}</span> <span class="bound">t</span>
  <span class="main">|</span> Some <span class="bound">X</span> <span class="main">⇒</span> rbt_comp_insert <span class="free">c</span> <span class="bound">a</span> <span class="main">(</span><span class="bound">X</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">b</span><span class="main">}</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rbt_set_to_rbt_comp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">,</span> unit<span class="main">)</span> rbt <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span> set<span class="main">)</span> rbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rbt_set_to_rbt_comp</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> RBT_Impl.fold <span class="main">(</span><span class="main">λ</span><span class="bound">ab</span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> add_to_rbt_comp <span class="bound">ab</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> RBT_Impl.Empty"</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"comparator <span class="free">c</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> add_to_rbt_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"add_to_rbt_comp <span class="main">=</span> ord.add_to_rbt <span class="main">(</span>lt_of_comp <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> add_to_rbt_comp_def ord.add_to_rbt_def rbt_comp_lookup<span class="main">[</span><span class="operator">OF</span> c<span class="main">]</span> rbt_comp_insert<span class="main">[</span><span class="operator">OF</span> c<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> rbt_set_to_rbt_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"rbt_set_to_rbt_comp <span class="main">=</span> ord.rbt_set_to_rbt <span class="main">(</span>lt_of_comp <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rbt_set_to_rbt_comp_def ord.rbt_set_to_rbt_def add_to_rbt_comp
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rbt_comp_lookup_map_of<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> ccompare<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ID ccompare <span class="main">=</span> <span class="main">(</span>Some <span class="free">c</span> <span class="main">::</span> <span class="tfree">'a</span> comparator option<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ord.is_rbt <span class="main">(</span>lt_of_comp <span class="free">c</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rbt_comp_lookup <span class="free">c</span> <span class="free">t</span> <span class="main">=</span> map_of <span class="main">(</span>RBT_Impl.entries <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"comparator <span class="main">(</span><span class="free">c</span> <span class="main">::</span> <span class="tfree">'a</span> comparator<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ID_ccompare'<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> linorder.map_of_entries<span class="main">[</span><span class="operator">OF</span> comparator.linorder<span class="main"><span class="main">[</span></span><span class="operator">OF</span> c<span class="main"><span class="main">]</span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> rbt_comp_lookup<span class="main">[</span><span class="operator">OF</span> c<span class="main">]</span> ord.is_rbt_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dom_rbt_comp_lookup<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> ccompare<span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> rbt"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ID ccompare <span class="main">=</span> <span class="main">(</span>Some <span class="free">c</span> <span class="main">::</span> <span class="tfree">'a</span> comparator option<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ord.is_rbt <span class="main">(</span>lt_of_comp <span class="free">c</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dom <span class="main">(</span>rbt_comp_lookup <span class="free">c</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>RBT_Impl.keys <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"comparator <span class="main">(</span><span class="free">c</span> <span class="main">::</span> <span class="tfree">'a</span> comparator<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ID_ccompare'<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> linorder.rbt_lookup_keys<span class="main">[</span><span class="operator">OF</span> comparator.linorder<span class="main"><span class="main">[</span></span><span class="operator">OF</span> c<span class="main"><span class="main">]</span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> rbt_comp_lookup<span class="main">[</span><span class="operator">OF</span> c<span class="main">]</span> ord.is_rbt_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> comparator_prod<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ID ccompare <span class="main">=</span> <span class="main">(</span>Some ccomp <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> ccompare comparator option<span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"ID ccompare <span class="main">=</span> <span class="main">(</span>Some ccomp <span class="main">::</span> <span class="tfree">'b</span> <span class="main">::</span> ccompare comparator option<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ID ccompare <span class="main">=</span> <span class="main">(</span>Some ccomp <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> comparator option<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ccompare_prod_def ID_Some <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> comparator_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ID ccompare <span class="main">=</span> <span class="main">(</span>Some ccomp <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> ccompare comparator option<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ID ccompare <span class="main">=</span> <span class="main">(</span>Some ccomp <span class="main">::</span> <span class="tfree">'a</span> set comparator option<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ccompare_set_def ID_Some<span class="main">)</span>
     <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> ID_code map_option_is_None option.collapse option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dom_map_of_map<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span> <span class="main">⟹</span> dom <span class="main">(</span>map_of <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_map_fstD<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> distinct <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span> linorder
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rbt_bulkload_keys<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span> <span class="main">⟹</span>
  set <span class="main">(</span>RBT_Impl.keys <span class="main">(</span>rbt_bulkload <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rbt_lookup_keys<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> rbt_lookup_rbt_bulkload dom_map_of_map<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mapping_to_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> ccompare<span class="main">,</span> <span class="tfree">'b</span> <span class="main">::</span> ccompare set<span class="main">)</span> rbt <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span> set<span class="main">)</span> set_rbt"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mapping_to_set</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> RBT_Mapping2.bulkload <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>RBT_Impl.entries <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ccomps<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ID ccompare <span class="main">=</span> <span class="main">(</span>Some <span class="free">c</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> ccompare comparator option<span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"ID ccompare <span class="main">=</span> <span class="main">(</span>Some <span class="free">c'</span> <span class="main">::</span> <span class="tfree">'b</span> <span class="main">::</span> ccompare comparator option<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ID ccompare <span class="main">=</span> <span class="main">(</span>Some ccomp <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> comparator option<span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"ID ccompare <span class="main">=</span> <span class="main">(</span>Some ccomp <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span> set<span class="main">)</span> comparator option<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> comparator_prod assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span>
    <span class="keyword1"><span class="command">using</span></span> comparator_prod comparator_set assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> option.collapse option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> proj_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> ccompare <span class="main">×</span> <span class="tfree">'b</span> <span class="main">::</span> ccompare<span class="main">)</span> set_rbt"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Equiv_Relations.proj <span class="main">(</span>RBT_set <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> ID <span class="keyword1">CCOMPARE</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span>
    Code.abort <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''proj: ccompare = None''</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Equiv_Relations.proj <span class="main">(</span>RBT_set <span class="free">t</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> Some <span class="bound">c</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> ID <span class="keyword1">CCOMPARE</span><span class="main">(</span><span class="tfree">'b</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span>
    Code.abort <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''proj: ccompare = None''</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Equiv_Relations.proj <span class="main">(</span>RBT_set <span class="free">t</span><span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> Some <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="keyword1">let</span> <span class="bound">m</span> <span class="main">=</span> rbt_set_to_rbt_comp <span class="bound">c</span> <span class="main">(</span>RBT_Mapping2.impl_of <span class="free">t</span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> rbt_comp_lookup <span class="bound">c</span> <span class="bound">m</span> <span class="bound">a</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">{}</span> <span class="main">|</span> Some <span class="bound">X</span> <span class="main">⇒</span> <span class="bound">X</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">c</span> <span class="skolem">c'</span>
    <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"ord.is_rbt cless <span class="main">(</span><span class="skolem">t</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">,</span> unit<span class="main">)</span> rbt<span class="main">)</span> <span class="main">∨</span>
      ID ccompare <span class="main">=</span> <span class="main">(</span>None <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> comparator option<span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"ID ccompare <span class="main">=</span> <span class="main">(</span>Some <span class="skolem">c</span> <span class="main">::</span> <span class="tfree">'a</span> comparator option<span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"ID ccompare <span class="main">=</span> <span class="main">(</span>Some <span class="skolem">c'</span> <span class="main">::</span> <span class="tfree">'b</span> comparator option<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">note</span></span> cab_ID_ccomp <span class="main">=</span> ccomps<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> is_rbt_t<span class="main">:</span> <span class="quoted"><span class="quoted">"ord.is_rbt cless <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cab_ID_ccomp mapping_comparator assms<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"comparator <span class="main">(</span><span class="skolem">c</span> <span class="main">::</span> <span class="tfree">'a</span> comparator<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ID_ccompare'<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">note</span></span> c_class <span class="main">=</span> comparator.linorder<span class="main">[</span><span class="operator">OF</span> c<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> rbt_comp_lookup<span class="main">:</span> <span class="quoted"><span class="quoted">"rbt_comp_lookup <span class="skolem">c</span> <span class="main">(</span>rbt_set_to_rbt_comp <span class="skolem">c</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">=</span>
      map_of <span class="main">(</span>RBT_Impl.entries <span class="main">(</span>ord.rbt_set_to_rbt <span class="main">(</span>lt_of_comp <span class="skolem">c</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> rbt_comp_lookup_map_of<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> linorder.is_rbt_rbt_set_to_rbt<span class="main"><span class="main">[</span></span><span class="operator">OF</span> c_class<span class="main"><span class="main">]</span></span><span class="main">]</span>
        rbt_set_to_rbt_comp<span class="main">[</span><span class="operator">OF</span> c<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> linorder.proj_rbt_set_to_mapping<span class="main">[</span><span class="operator">OF</span> comparator.linorder<span class="main"><span class="main">[</span></span><span class="operator">OF</span> c<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">,</span> <span class="operator">folded</span> rbt_comp_lookup<span class="main">]</span>
      dom_rbt_comp_lookup<span class="main">[</span><span class="operator">OF</span> cab_ID_ccomp is_rbt_t<span class="main">]</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> rw <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> RBT_set_def
    <span class="keyword1"><span class="command">using</span></span> rw
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> images_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> ccompare <span class="main">×</span> <span class="tfree">'b</span> <span class="main">::</span> ccompare<span class="main">)</span> set_rbt"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"images <span class="main">(</span>RBT_set <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> ID <span class="keyword1">CCOMPARE</span><span class="main">(</span><span class="tfree">'a</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span>
    Code.abort <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''images: ccompare = None''</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> images <span class="main">(</span>RBT_set <span class="free">t</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> Some <span class="bound">c</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> ID <span class="keyword1">CCOMPARE</span><span class="main">(</span><span class="tfree">'b</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span>
    Code.abort <span class="main">(</span><span class="keyword1">STR</span> <span class="inner_quoted">''images: ccompare = None''</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> images <span class="main">(</span>RBT_set <span class="free">t</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> Some <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> RBT_set <span class="main">(</span>mapping_to_set <span class="main">(</span>rbt_set_to_rbt_comp <span class="bound">c</span> <span class="main">(</span>RBT_Mapping2.impl_of <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">c</span> <span class="skolem">c'</span>
    <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"ord.is_rbt cless <span class="main">(</span><span class="skolem">t</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">,</span> unit<span class="main">)</span> rbt<span class="main">)</span> <span class="main">∨</span>
      ID ccompare <span class="main">=</span> <span class="main">(</span>None <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> comparator option<span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"ID ccompare <span class="main">=</span> <span class="main">(</span>Some <span class="skolem">c</span> <span class="main">::</span> <span class="tfree">'a</span> comparator option<span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"ID ccompare <span class="main">=</span> <span class="main">(</span>Some <span class="skolem">c'</span> <span class="main">::</span> <span class="tfree">'b</span> comparator option<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">note</span></span> cab_ID_ccomp <span class="main">=</span> ccomps<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">note</span></span> cab_set_ID_ccomp <span class="main">=</span> ccomps<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> is_rbt_t<span class="main">:</span> <span class="quoted"><span class="quoted">"ord.is_rbt cless <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cab_ID_ccomp mapping_comparator assms<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"comparator <span class="main">(</span><span class="skolem">c</span> <span class="main">::</span> <span class="tfree">'a</span> comparator<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ID_ccompare'<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">have</span></span> cab_set_ccomp<span class="main">:</span> <span class="quoted"><span class="quoted">"comparator <span class="main">(</span>ccomp <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span> set<span class="main">)</span> comparator<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ID_ccompare'<span class="main">[</span><span class="operator">OF</span> cab_set_ID_ccomp<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">note</span></span> c_class <span class="main">=</span> comparator.linorder<span class="main">[</span><span class="operator">OF</span> c<span class="main">]</span>
    <span class="keyword1"><span class="command">note</span></span> cab_set_class <span class="main">=</span> comparator.linorder<span class="main">[</span><span class="operator">OF</span> cab_set_ccomp<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>RBT_Impl.entries <span class="main">(</span>ord.rbt_set_to_rbt <span class="main">(</span>lt_of_comp <span class="skolem">c</span><span class="main">)</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> linorder.distinct_entries<span class="main">[</span><span class="operator">OF</span> c_class<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"ord.rbt_set_to_rbt <span class="main">(</span>lt_of_comp <span class="skolem">c</span><span class="main">)</span> <span class="skolem">t</span>"</span></span><span class="main">]</span>
        linorder.is_rbt_rbt_set_to_rbt<span class="main">[</span><span class="operator">OF</span> c_class<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ord.is_rbt_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> distinct_map_fstD<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"images <span class="main">(</span>dom <span class="main">(</span>rbt_comp_lookup ccomp <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> dom <span class="main">(</span>rbt_comp_lookup ccomp
      <span class="main">(</span>rbt_comp_bulkload ccomp <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="main">()</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>RBT_Impl.entries <span class="main">(</span>rbt_set_to_rbt_comp <span class="skolem">c</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dom_rbt_comp_lookup<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cab_ID_ccomp is_rbt_t<span class="main"><span class="main">]</span></span>
          linorder.images_rbt_set_to_mapping<span class="main"><span class="main">[</span></span><span class="operator">OF</span> c_class<span class="main"><span class="main">]</span></span>
          rbt_set_to_rbt_comp<span class="main"><span class="main">[</span></span><span class="operator">OF</span> c<span class="main"><span class="main">]</span></span> rbt_comp_bulkload<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cab_set_ccomp<span class="main"><span class="main">]</span></span>
          dom_rbt_comp_lookup<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cab_set_ID_ccomp linorder.rbt_bulkload_is_rbt<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> cab_set_class<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span>
          linorder.rbt_bulkload_keys<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cab_set_class distinct<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> RBT_set_def mapping_to_set_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</body>

</html>